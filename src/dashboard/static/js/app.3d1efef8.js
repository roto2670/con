(function(t){function e(e){for(var i,n,d=e[0],c=e[1],r=e[2],h=0,m=[];h<d.length;h++)n=d[h],o[n]&&m.push(o[n][0]),o[n]=0;for(i in c)Object.prototype.hasOwnProperty.call(c,i)&&(t[i]=c[i]);l&&l(e);while(m.length)m.shift()();return a.push.apply(a,r||[]),s()}function s(){for(var t,e=0;e<a.length;e++){for(var s=a[e],i=!0,d=1;d<s.length;d++){var c=s[d];0!==o[c]&&(i=!1)}i&&(a.splice(e--,1),t=n(n.s=s[0]))}return t}var i={},o={app:0},a=[];function n(e){if(i[e])return i[e].exports;var s=i[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=i,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(s,i,function(e){return t[e]}.bind(null,i));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/";var d=window["webpackJsonp"]=window["webpackJsonp"]||[],c=d.push.bind(d);d.push=e,d=d.slice();for(var r=0;r<d.length;r++)e(d[r]);var l=c;a.push([0,"chunk-vendors"]),s()})({0:function(t,e,s){t.exports=s("56d7")},"034f":function(t,e,s){"use strict";var i=s("64a9"),o=s.n(i);o.a},"1aa9":function(t,e){window.CONSTANTS={HUB_VIEW:{NOT_IN_MAP:0,IN_MAP:1},URL:{BASE_IMG:"static/location/imgs/",YOUR_CLOUD:"https://c2.prota.space",CONSOLE:""},GADGET_INFO:{1:"JUMBO DRILL(2B)",2:"JUMBO DRILL(3B)",3:"CHARGING CAR",4:"WHEEL LOADER",5:"DUMP TRUCK",6:"EXCAVATOR(WHEEL)",7:"EXCAVATOR(CRAWLER)",8:"SHOTCRETE MACHINE",9:"JCB",10:"CORE DRILLING MACHINE",11:"DOZER",12:"GROUTING MACHINE",13:"MAI PUMP",14:"MOBILE PRODUCTION UNIT",15:"CHARGING PUMP UNIT",16:"BUS"},MINIMUM_NUMBER:{HUB:1,FILTERED_BEACONS:16}}},"1d68":function(t,e,s){},"54d9":function(t,e,s){"use strict";var i=s("b347"),o=s.n(i);o.a},"56d7":function(t,e,s){"use strict";s.r(e);var i={};s.r(i),s.d(i,"updateIpcamData",function(){return u}),s.d(i,"setHubLocation",function(){return p}),s.d(i,"getInfo",function(){return g}),s.d(i,"getIpcams",function(){return b}),s.d(i,"getHubs",function(){return f}),s.d(i,"getHubListConnectedToGadget",function(){return v}),s.d(i,"getBeacons",function(){return w}),s.d(i,"getDetectBeaconList",function(){return I}),s.d(i,"getGadget",function(){return E}),s.d(i,"getMapFiles",function(){return y}),s.d(i,"getBeaconImg",function(){return N}),s.d(i,"postMapFile",function(){return k});var o={};s.r(o),s.d(o,"BeaconDetector",function(){return C});var a=s("2b0e"),n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"locationTracking"}},[s("div",{directives:[{name:"show",rawName:"v-show",value:t.isLoaded,expression:"isLoaded"}],staticClass:"loading"},[t._m(0)]),s("Top"),s("Map",{on:{"map-load":t.handleMapLoad}})],1)},d=[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"main-loader"},[s("div"),s("div"),s("div"),s("div")])}],c=function(){var t=this,e=t.$createElement,s=t._self._c||e;return t.isEmptyUrl?s("div",{attrs:{id:t.id}}):t._e()},r=[],l=s("ec60"),h=s("bc3a"),m=s.n(h);const u=(t,e,s)=>{m.a.post(window.CONSTANTS.URL.CONSOLE+"/dash/cam/location",{cam:t},{headers:{"Content-Type":"application/json"}}).then(s=>{console.debug(`Sucess to post cam location in id ${t.id}`),e()}).catch(t=>{s()})},p=(t,e)=>{m.a.post(window.CONSTANTS.URL.CONSOLE+"/dash/hubs/location",{hub:t},{headers:{"Content-Type":"application/json"}}).then(t=>{e()}).catch(t=>{e()})},g=t=>{m()({url:window.CONSTANTS.URL.CONSOLE+"/dash/location/info",method:"GET",responseType:"text"}).then(e=>{e.data?t(e.data):(console.log("File is not exist"),t())}).catch(e=>{console.warn("Failed to get info ",e),t()})},b=t=>{m()({url:window.CONSTANTS.URL.CONSOLE+"/dash/cam/list/ipcam",method:"GET",responseType:"text"}).then(e=>{e.data?t(e.data):(console.log("Ipcam does not exist"),t([]))}).catch(e=>{console.warn("Failed to get ipCams",e),t([])})},f=t=>{m()({url:window.CONSTANTS.URL.CONSOLE+"/dash/scanner/list",method:"GET",responseType:"text"}).then(e=>{e.data?t(e.data):(console.log("File is not exist"),t([]))}).catch(e=>{console.warn("Failed to get hubs ",e),t([])})},v=(t,e)=>{m()({url:window.CONSTANTS.URL.CONSOLE+"/dash/hubs/detected/"+t,method:"GET",responseType:"text"}).then(t=>{const s=t.data;s&&_.isArray(s.data)?e(s):(console.log("fail to load connectedGadget"),e({}))}).catch(t=>{console.warn("Failed to get hub list connected to gadget ",t),e({})})},w=(t,e)=>{m()({url:window.CONSTANTS.URL.CONSOLE+"/dash/beacons/list/"+t,method:"GET",responseType:"text"}).then(t=>{t.data?e(t.data):(console.log("beacon is not exist"),e([]))}).catch(t=>{console.warn("Failed to get beacons ",t),e([])})},I=(t,e,s)=>{m()({url:window.CONSTANTS.URL.CONSOLE+"/dash/beacons/detected/"+t,method:"GET",responseType:"text"}).then(t=>{const i=t.data;i&&_.isArray(i.data)?e(i.data):s("not exist")}).catch(t=>{s(t)})},E=(t,e,s)=>{m()({url:window.CONSTANTS.URL.CONSOLE+"/dash/beacons/"+t,method:"GET",responseType:"text"}).then(i=>{i.data?e(i.data):s(`Failed to get gadget, id: ${t}`)}).catch(t=>{s(t)})},y=t=>{const e=window.CONSTANTS.URL.BASE_IMG+"map.png";m()({url:window.CONSTANTS.URL.CONSOLE+"/dashboard/location/view",method:"GET",responseType:"text"}).then(s=>{s.data?(console.log("Success to Get map image file"),t(window.location.protocol+"//"+window.location.host+s.data)):(console.log("Sorry, Img file does not exist"),t(e))}).catch(s=>{console.warn("Failed to get map file ",s),t(e)})},N=(t,e,s)=>{var i=window.CONSTANTS.URL.YOUR_CLOUD+"/mib/v1/sense/"+t;m()({method:"GET",headers:{},url:i}).then(t=>{t&&t.data?e(t.data.v.img_url):s()}).catch(t=>{s(t)})},k=(t,e,s)=>{let i=new FormData;t?(i.append("file",t),m.a.post(window.CONSTANTS.URL.CONSOLE+"/dashboard/location/upload",i,{headers:{"Content-Type":"multiart/form-data"}}).then(t=>{console.log("Success to Upload map image file"),e("http://"+window.location.host+t.data)}).catch(t=>{s(t)})):s()};let T=null;class C{constructor(t,e,s){if(T)return T;this._timers=[],this.isRunning=!1,this._vm=t,this._detectedCallback=e||function(){},this._failCallback=s||function(){},this.check_threshold=null,this.info=null,T=this}start(t){this.info=t,this.isRunning&&(this.isRunning=!0),_.isNumber(this.info.interval)?this.check_threshold=1e3*this.info.interval:this.check_threshold=6e4,this._timers.push(setInterval(()=>{this._refreshBeacons()},this.check_threshold)),console.info("Beacon detector started")}stop(){this._clearTimer(),this.isRunning=!1,console.info("Beacon detector stopped")}_refreshBeacons(){let t=this._vm.$store.getters.getHubsWhichIsInMap,e=0,s=0;_.isEmpty(t)||w(this.info.product_id,i=>{this._vm.$store.commit("removeGadgets"),this._vm.$store.commit("removeHubs"),this._vm.$store.commit("addDetectedGadget",i),_.forEach(t,t=>{t.view===window.CONSTANTS.HUB_VIEW.IN_MAP&&(e++,I(t.id,t=>{s++,this._vm.$store.commit("addDetectedHubGadget",t),s===e&&this._detectedCallback(console.debug("Success to update"))},t=>{this._failCallback(t)}))})},t=>{this._failCallback(t)})}_clearTimer(){this._.forEach(this._timers,t=>{try{clearInterval(t)}catch(e){console.warn("Failed to clear detector timer.",e)}}),this._timers=[]}}var L={methods:{isNumber:t=>!_.isNaN(t)&&_.isNumber(t)}},M=(s("5118"),{name:"Map",data(){return{id:"map",map:null,url:"",zoomLv:"",layer:"",hubLayer:"",workerLayer:"",camLayer:"",ipcam:"",ipcams:[],contextCoordinate:null,infoWindow:null,hubInfoWindow:null,ipcamInfoWindow:null,gadgetInfoNumber:this._.keys(window.CONSTANTS.GADGET_INFO),selectFilteredBeaconsUpdateBefore:this._.keys(window.CONSTANTS.GADGET_INFO),selectFilteredBeaconsUpdateAfter:this._.keys(window.CONSTANTS.GADGET_INFO),bcns:{},bcnsData:{},hubsData:{},options:{items:[]},markerMap:{hubs:{},gadgets:{},cams:{}}}},methods:{initloadMap(){this.showLoading(),this.services.getMapFiles(t=>{this.map=new l["c"](this.id,{center:[90,50],zoom:6,maxZoom:9,minZoom:4,maxExtent:new l["a"](5,5,170,80),zoomAnimation:!1,zoomInCenter:!0,panAnimation:!1,dragRotate:!1,dragPitch:!1,drgaRotatePitch:!1,touchGesture:!1,touchZoom:!1,touchRotate:!1,touchPitch:!1,touchZoomRotate:!1,doubleClickZoom:!1,baseLayer:new l["b"]("base",[{url:t,extent:[0,0,180,85],opactiy:1}],{opactiy:1})}),this.map.once("baselayerload",()=>{this.layer=new l["e"]("vector").addTo(this.map),this.hubLayer=new l["e"]("vector1").addTo(this.map),this.workerLayer=new l["e"]("vector2").addTo(this.map),this.camLayer=new l["e"]("vector3").addTo(this.map),this.hubLayer.setZIndex(3),this.workerLayer.setZIndex(1),this.initContextMenu(),this.services.getInfo(t=>{t&&(this.loadHubs(t),this.loadIpCams(),this.initBeaconLocationHandler(t)),this.hideLoading()})})})},initBeaconLocationHandler(t,e,s){this.beaconDetector=new C(this,()=>{let t=this.$store.getters.getHubsWhichIsInMap;if(this.hubInfoWindow&&this.hubInfoWindow.remove(),this._.isEmpty(this.infoWindow)||this.infoWindow.remove(),this.selectFilteredBeaconsUpdateAfter=this._.clone(this.selectFilteredBeaconsUpdateBefore),this._.isEmpty(t))console.warn("There is no hub id, so we cannot update hub data");else{let e={};this._.forEach(t,t=>{e[t.id]=this.$store.getters.getHub(t.id),this.removeGadgetMarkersWhenHubIsMoved(t.id)}),this.hasSameGadget(()=>{this._.forEach(e,(t,e)=>{this.drawWorkers(e,t.custom.map_location)})},t=>{s(t)})}},t=>{console.warn("There's no data to update")}),this.beaconDetector.start(t)},initContextMenu(){this.contextMenuOption={items:[{item:"Add Scanner",click:this.handleAddHub},"-",{item:"Add IPCAM",click:this.handleAddIPCam}]},this.contextMenu=this.map.setMenu(this.contextMenuOption).openMenu(),this.map.closeMenu(),this.map.on("contextmenu",t=>{this.contextCoordinate=t.coordinate,this.map.openMenu(t.coordinate)})},loadHubs(t){console.debug("Try load hubs"),this.services.getBeacons(t.product_id,t=>{this.$store.commit("addDetectedGadget",t),this._loadHubs()})},_loadHubs(){this.services.getHubs(t=>{this.$store.commit("addHubs",t);const e=this.$store.getters.getHubs;this._.forEach(e,t=>{_.isEmpty(t.custom)||this.drawHub(t.id,t.custom.map_location)})})},loadGadgets(t,e,s){this.services.getDetectBeaconList(t,t=>{this.$store.commit("addDetectedHubGadget",t),this.hasSameGadget(e)},t=>{s(t)})},handleAddHub(t){this.showhubList(t=>{this.map.closeMenu(t),this.drawHub(t,this.contextCoordinate)})},showhubList(t){this.map.closeMenu(),this.services.getHubs(e=>{this.$store.commit("addHubs",e),this.options.items=[];let s=new l["d"]([this.contextCoordinate.x,this.contextCoordinate.y],{visible:!1}).addTo(this.hubLayer);if(this._.isEmpty(e)){let t={item:"No Scanner to load"};this.options.items.push(t),s.setMenu(this.options).openMenu()}else{if(this._.forEach(e,(s,i)=>{if(!this._.has(this.markerMap.hubs,s.id))if(s.custom&&s.custom.map_location)console.debug(`The ${s.name} hub has location data. so skip`);else{let o={item:s.name,click:()=>{t(s.id)}};e.length-i>1?this.options.items.push(o,"-"):this.options.items.push(o)}}),this._.isEmpty(this.options.items)){let t={item:"No Scanner",click:()=>{}};this.options.items.push(t)}s.setMenu(this.options).openMenu()}},function(t){console.warn("Failed to load hub list.")})},drawHub(t,e){console.debug("Try draw hub, id: ",t);let s=null;this.zoomLv=this.map.getZoom()/11*50,s=new l["d"]([e.x,e.y],{symbol:{markerFile:window.CONSTANTS.URL.BASE_IMG+"icon-hub-tab.svg",markerWidth:this.zoomLv,markerHeight:this.zoomLv},ZIndex:3}).addTo(this.hubLayer),s.on("click",()=>{this.showHubInfoWindow(t,s)}),this.markerMap.hubs[t]=s,this._updateHubLocation(t,e.x,e.y,()=>{this.$store.commit("HubIsInMap",t),this.loadGadgets(t,()=>{this.drawWorkers(t,e),s.on("dragstart draaging dragend",e=>{var i=document.getElementsByClassName("hub-move-button")[0].innerHTML,o=i.replace("Move","SetLocation");document.getElementsByClassName("hub-move-button")[0].innerHTML=o,document.getElementsByClassName("hub-move-button")[0].onclick=()=>{s.closeInfoWindow(),s.config("draggable",!1),this.removeGadgetMarkersWhenHubIsMoved(t),this._updateHubLocation(t,e.coordinate.x,e.coordinate.y,()=>{this.loadGadgets(t,()=>{this.drawWorkers(t,s._coordinates)})})}})},t=>{console.log("load gadgets failed",t)}),this.map.on("zoomend",t=>{this.zoomLv=this.map.getZoom()/11*50,s.updateSymbol({markerWidth:this.zoomLv,markerHeight:this.zoomLv})})})},removeHubMarker(t){let e=this.markerMap.hubs[t];if(this._.isEmpty(e))console.warn(`Failed to remove hub marker, cannot find marker by given id: ${t}`);else{let s=this.$store.getters.getHub(t);this._.isEmpty(s)?console.warn(`Failed to clear hub location, cannot found hub model by given id: ${t}`):(delete s.custom.map_location,this.services.setHubLocation(s,this._.noop),console.log("success to remove hubmarker")),this.$store.commit("HubIsNotInMap",t),e.remove()}let s=this.$store.getters.getHubsWhichIsInMap,i=this.$store.getters.getdetectedGadgetList;this._.forEach(s,e=>{e.view===window.CONSTANTS.HUB_VIEW.NOT_IN_MAP&&this._.forEach(i,(e,s)=>{this._.includes(e.hubIdList,t)&&(e.hubIdList.length>1||(e.view=window.CONSTANTS.HUB_VIEW.NOT_IN_MAP,delete i[s],this.bcnsData[s].marker.remove(),delete this.bcnsData[s]),e.hubIdList=this._.without(e.hubIdList,t))})}),this.hasSameGadget(()=>{this._.forEach(s,t=>{t.view===window.CONSTANTS.HUB_VIEW.IN_MAP&&this.drawWorkers(t.id,this.markerMap.hubs[t.id]._coordinates)})}),delete this.markerMap.hubs[t]},removeGadgetMarkersWhenHubIsMoved(t){let e=this.markerMap.gadgets[t];this._.isEmpty(e)||this._.forEach(e,e=>{e.remove(),this.markerMap.gadgets[t]={}}),delete this.markerMap.gadgets[t]},showHubInfoWindow(t,e){let s="",i=null,o={},a=this.$store.getters.getBeaconWithHubs(t),n=this.$store.getters.getHub(t);this._.isEmpty(this.infoWindow)||this.infoWindow.remove(),this._.isEmpty(a)?(s+="<li>Theres no hub to load</li>",i+=0):this._.forEach(a,t=>{if(!o[t.gid]){o[t.gid]={};var e=this.$store.getters.getdetectedGadgetName(t.gid);this._.isEmpty(e)?s+=`<li id="${t.gid}">UNKNOWN</li>`:s+=`<li id="${t.gid}">${e}</li>`}i=this._.keys(o).length}),e.setInfoWindow({content:'<div class="worker_menu"><div class="worker"><div class="workerId"><div class="workerkey">SCANNER</div><div class="hubInfo" title="'+n.name+'">'+n.name+'</div></div><div class="workerCount"><div class="workerkey">WORKER</div>'+i+'</div><div class="movebtn"><button class="hub-move-button">Move</button></div><div class="removebtn"><button class="hub-remove-button">Remove</button></div></div><div class="workerInfo">'+s+"</div></div>",width:350}),e.openInfoWindow(),this.ipcamInfoWindow=e._infoWindow,this._.forEach(a,t=>{if(!this._.isEmpty(this.bcnsData[t.gid])){let e=this.$store.getters.getdetectedGadgetList[t.gid];document.getElementById(t.gid).onclick=()=>{this.showGadgetInFoWindow(e,this.bcnsData[t.gid].marker)}}}),document.getElementsByClassName("hub-move-button")[0].onclick=()=>{var t=document.getElementsByClassName("hub-move-button")[0].innerHTML,s=t.replace("Move","SetLocation");document.getElementsByClassName("hub-move-button")[0].innerHTML=s,e.config("draggable",!0)},document.getElementsByClassName("hub-remove-button")[0].onclick=()=>{this.removeHubMarker(t)},document.getElementsByClassName("maptalks-close")[0].onclick=()=>{e.config("draggable",!1)}},drawWorkers(t,e){let s=this._.values(this.$store.getters.getdetectedGadgetList),i=1;this.zoomLv=this.map.getZoom()/11*50,this._.forEach(s,(s,o)=>{let a=null,n=[];if(this._.includes(s.hubIdList,t)){this.bcnsData[s.gid]&&s.view===window.CONSTANTS.HUB_VIEW.IN_MAP&&this.bcnsData[s.gid].marker.remove(),this._.isEmpty(s.custom)?n.push(e.x,e.y-i/10):n.push(s.custom.x,s.custom.y),a=new l["d"](n,{symbol:{markerFile:window.CONSTANTS.URL.BASE_IMG+`icon-worker${s.tags}`+"-tab.svg",markerWidth:this.zoomLv,markerHeight:this.zoomLv}}).addTo(this.workerLayer),this.$store.commit("GadgetIsInMap",s.gid),this._.isEmpty(this.bcnsData[s.gid])?this.bcnsData[s.gid]={marker:a,tags:s.tags}:this.bcnsData[s.gid].marker=a,this._.includes(this.selectFilteredBeaconsUpdateBefore,this._.first(s.tags))||(a.hide(),this.$store.commit("GadgetIsnotInMap",s.gid)),_.isEmpty(s.tags)&&a.updateSymbol("markerFile",window.CONSTANTS.URL.BASE_IMG+"icon-alert-tab.svg"),a.on("click",()=>{this.showGadgetInFoWindow(s,this.bcnsData[s.gid].marker)});let o=this.markerMap.gadgets[t];o||(o=[],this.markerMap.gadgets[t]=o),this.map.on("zoomend",t=>{this.zoomLv=this.map.getZoom()/11*50,a.updateSymbol({markerWidth:this.zoomLv,markerHeight:this.zoomLv})}),a.setZIndex(1),o.push(a),i++}})},showGadgetInFoWindow(t,e){let s=window.CONSTANTS.GADGET_INFO[this.bcnsData[t.gid].tags],i=this.$store.getters.getdetectedGadgetList[t.gid].hubIdList,o=null,a="";this._.isEmpty(i)||(this._.forEach(i,t=>{o=this.$store.getters.getHub(t).name,a+='<div class="scannerName" title="'+o+'">'+o+"</div>"}),a+="</div>"),e.setInfoWindow({content:'<div class="bcns"><div class="bcnsInfo1"><div class="bcnskey1">NAME</div><div class="bcnName1" title="'+t.name+'">'+t.name+'</div><div class="bcnskey1">KIND</div><div class="bcnName1" title="'+s+'">'+s+'</div><div class="scannerData">SCANNER</div><div class="scannerNameList">'+a+'</div><div class="loader"><div></div><div></div><div></div><div></div></div><img class="bcnsImg1" src="'+window.CONSTANTS.URL.BASE_IMG+"item"+t.tags+'.png"></img></div>',width:400,bottom:11}),e.openInfoWindow();const n=this._.first(document.getElementsByClassName("loader"));this.services.getBeaconImg(t.gid,t=>{let e=document.getElementsByClassName("bcnsImg1");t&&!this._.isEmpty(e)&&(e[0].src=t),n&&n.remove()},t=>{n&&n.remove()})},loadIpCams(){console.debug("Try load ipcams"),this.services.getIpcams(t=>{this.$store.commit("addIpcams",t),this.drawIpCams(t)})},handleAddIPCam(t){this.showIpCamList(t=>{this.map.closeMenu(t),this.drawIpcam(t,this.contextCoordinate)})},showIpCamList(t){this.map.closeMenu(),this.services.getIpcams(e=>{this.options.items=[];let s=new l["d"]([this.contextCoordinate.x,this.contextCoordinate.y],{visible:!1}).addTo(this.camLayer);if(this._.isEmpty(e)){let t={item:"No Ipcams to load"};this.options.items.push(t),s.setMenu(this.options).openMenu()}else{if(this._.forEach(e,(s,i)=>{if(!this._.has(this.markerMap.cams,s.id))if(s.custom&&s.custom.map_location)console.debug(`The ${s.name} ipcam has location data. so skip`);else{let o={item:s.name,click:()=>{t(s.id)}};e.length-i>1?this.options.items.push(o,"-"):this.options.items.push(o)}}),this._.isEmpty(this.options.items)){let t={item:"No Ipcams",click:()=>{}};this.options.items.push(t)}s.setMenu(this.options).openMenu()}},function(t){console.warn("Failed to load ipcam list.")})},drawIpCams(t){this._.forEach(t,t=>{this._.isEmpty(t.custom)&&this._.isEmpty(t.custom.map_location)||this.drawIpcam(t.id,t.custom.map_location)})},drawIpcam(t,e){console.debug("Try draw ipcam, id: ",t);let s=null;var i=this.$store.getters.getIpCams(t);this.zoomLv=this.map.getZoom()/11*50;let o=`${window.CONSTANTS.URL.BASE_IMG}icon-ipcam-default.svg`;i.custom.is_visible_moi&&(o=`${window.CONSTANTS.URL.BASE_IMG}icon-ipcam-checked.svg`),s=new l["d"]([e.x,e.y],{symbol:{markerFile:o,markerWidth:this.zoomLv,markerHeight:this.zoomLv},ZIndex:3}).addTo(this.camLayer),s.on("click",()=>{this.showIpcamWindow(t,s)}),this.markerMap.cams[t]=s,i.custom.map_location={x:e.x,y:e.y},this._updateIpcamData(i,()=>{this.$store.commit("updateIpcamData",i)},t=>{console.log("load ipcam failed",t)}),this.map.on("zoomend",t=>{this.zoomLv=this.map.getZoom()/11*50,s.updateSymbol({markerWidth:this.zoomLv,markerHeight:this.zoomLv})}),s.on("dragstart draaging dragend",i=>{var o=document.getElementsByClassName("ipcam-move-button")[0].innerHTML,a=o.replace("Move","SetLocation");document.getElementsByClassName("ipcam-move-button")[0].innerHTML=a,document.getElementsByClassName("ipcam-move-button")[0].onclick=()=>{s.closeInfoWindow(),s.config("draggable",!1);var i=this.store.getters.getIpcams(t);i.custom.map_location={x:e.x,y:e.y},this._updateIpcamData(i,()=>{this.$store.commit("updateIpcamData",i)})}})},showIpcamWindow(t,e){let s=this.$store.getters.getIpCams(t),i=null;this._.isEmpty(this.infoWindow)||this.infoWindow.remove(),this._.isEmpty(s)?i+="UNKNOWN":i=s.name,e.setInfoWindow({content:'<div class="ipcam_menu"><div class="ipcam"><div class="ipcamId"><div class="ipcamKey">SCANNER</div><div class="ipcamInfo" title="'+i+'">'+i+'</div></div><div class="movebtn"><button class="ipcam-move-button">Move</button></div><div class="removebtn"><button class="ipcam-remove-button">Remove</button></div><div class="moi">MOI System</div><label class="repeat-onoff-toggle"><input class="repeat-toggle-button" type="checkbox"><span class="repeat-toggle-slider round"></span></label></div><div class="ipcam-right-panel"></div></div>',width:600}),e.openInfoWindow(),document.getElementsByClassName("repeat-toggle-button")[0].checked=!!s.custom.is_visible_moi,document.getElementsByClassName("repeat-toggle-button")[0].onchange=()=>{s.custom.is_visible_moi=document.getElementsByClassName("repeat-toggle-button")[0].checked;let t=`${window.CONSTANTS.URL.BASE_IMG}icon-ipcam-default.svg`;s.custom.is_visible_moi&&(t=`${window.CONSTANTS.URL.BASE_IMG}icon-ipcam-checked.svg`);let e=this.markerMap.cams[s.id];e&&e.updateSymbol({markerFile:t}),this._updateIpcamData(s,()=>{this.$store.commit("updateIpcamData",s)},t=>{console.log("load ipcam failed",t)})},document.getElementsByClassName("maptalks-msgBox")[0].style.height="400px";var o="vxg_media_player"+(new Date).getTime(),a=document.createElement("div");a.setAttribute("id",o),a.setAttribute("class","mediaplayer vxgplayer");var n=document.getElementsByClassName("ipcam-right-panel")[0];n.appendChild(a);let d="";this._.isEmpty(s.custom)||(d=`rtsp://${s.custom.id}:${s.custom.password}@${s.custom.ip}`),vxgplayer(o,{url:d,width:450,height:400,controls:!0,nmf_path:"media_player.nmf",nmf_src:"static/libs/mediaplayer/pnacl/Release/media_player.nmf"}).ready(function(){console.log(" =>ready player "+o),vxgplayer(o).src(d),vxgplayer(o).play(),console.log(" <=ready player "+o)});var c=vxgplayer(o);c.onError(function(t){console.warn("error",t.error())}),this.ipcamInfoWindow=e._infoWindow,document.getElementsByClassName("repeat-toggle-button")[0].checked=!!s.custom.is_visible_moi,document.getElementsByClassName("repeat-toggle-button")[0].onChange=()=>{s.custom.is_visible_moi=document.getElementsByClassName("repeat-toggle-button")[0].checked,this._updateIpcamData(s,()=>{this.$store.commit("updateIpcamData",s)},t=>{console.log("load ipcam failed",t)})},document.getElementsByClassName("ipcam-move-button")[0].onclick=()=>{var t=document.getElementsByClassName("ipcam-move-button")[0].innerHTML,s=t.replace("Move","SetLocation");document.getElementsByClassName("ipcam-move-button")[0].innerHTML=s,e.config("draggable",!0)},document.getElementsByClassName("ipcam-remove-button")[0].onclick=()=>{this.removeIpcamMarker(t)},document.getElementsByClassName("maptalks-close")[0].onclick=()=>{e.config("draggable",!1)}},removeIpcamMarker(t){let e=this.markerMap.cams[t];if(this._.isEmpty(e))console.warn(`Failed to remove ipcam marker, cannot find ipcam by given id: ${t}`);else{let s=this.$store.getters.getIpCams(t);this._.isEmpty(s)?console.warn(`Failed to clear ipcam location, cannot found ipcam model by given id: ${t}`):(delete s.custom.map_location,this.services.updateIpcamData(s,()=>{console.log("success to remove ipcam marker")},e=>{console.warn(`Failed to clear ipcam location, cannot found ipcam model by given id: ${t}`)})),e.remove()}delete this.markerMap.cams[t]},_updateIpcamData(t,e,s){this.services.updateIpcamData(t,e,s)},_updateHubLocation(t,e,s,i){let o=this.$store.getters.getHub(t);o&&e&&s?(this._.extend(o,{custom:{map_location:{x:e,y:s}}}),this.$store.commit("addHubLocation",o),this.services.setHubLocation(o,i)):console.warn("Failed to update hub location, given parms cannot be null.",o,e,s)},setGadgetLocation(t){let e={},s={},i=0,o=0,a=null,n=0,d=null,c=null,r=0;this._.forEach(t,t=>{let s=this.$store.getters.getHub(t.hid);a=t.gid,s&&!this._.isEmpty(s.custom)&&(e[t.hid]=s.custom.map_location,this.isNumber(e[t.hid].dist)||(e[t.hid].dist=t.dist))}),2===this._.size(e)?(this._.forEach(e,(t,e)=>{0===r?d=t:c=t,this.isNumber(t.dist)&&(n+=t.dist),r++}),i=(d.x*c.dist+c.x*d.dist)/n,o=(d.y*c.dist+c.y*d.dist)/n):(this._.forEach(e,(t,e)=>{this.isNumber(t.dist)?(i+=t.x+Math.abs(t.dist)/200,o+=t.y+Math.abs(t.dist)/200):console.warn(`There is no dist data in hubId: ${e}`)}),i/=this._.size(e),o/=this._.size(e)),this._.isEmpty(e)||(this._.forEach(t,t=>{s={hid:t.hid,gid:t.gid,x:i,y:o}}),this.$store.commit("addGadgetLocation",s))},hasSameGadget(t){const e=this.$store.getters.getdetectedGadgetList,s={};this._.forEach(e,(t,e)=>{t.hubIdList.length>1&&(s[e]={},s[e]=t.hubIdList)});let i=this._.keys(s).length,o=1;0==i?t():this._.forEach(s,(e,s)=>{this.services.getHubListConnectedToGadget(s,e=>{this.setGadgetLocation(e.data),i==o?t():o++})})},refilterBeacons(){this.selectFilteredBeaconsUpdateAfter=["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"];this.$store.getters.getdetectedGadgetList;this._.forEach(this.bcnsData,(t,e)=>{this._.includes(this.selectFilteredBeaconsUpdateAfter,this._.first(t.tags))&&(this.bcnsData[e].marker.show(),this.$store.commit("GadgetIsInMap",e))}),this.selectFilteredBeaconsUpdateBefore=this._.clone(this.selectFilteredBeaconsUpdateAfter)},setFilteredBeacons(){this._.isEmpty(this.selectFilteredBeaconsUpdateAfter)?this._.forEach(this.bcnsData,(t,e)=>{this.$store.commit("GadgetIsnotInMap",e),t.marker.hide()}):this._.forEach(this.bcnsData,(t,e)=>{this._.includes(this.selectFilteredBeaconsUpdateAfter,this._.first(t.tags))?(this.$store.commit("GadgetIsInMap",e),t.marker.show()):(this.$store.commit("GadgetIsnotInMap",e),t.marker.hide())}),this.selectFilteredBeaconsUpdateBefore=this._.clone(this.selectFilteredBeaconsUpdateAfter)},bgChangeWorkerTab(t){var e=document.getElementById("worker"+t).src,s=e.replace("icon-worker"+t+".svg","filter-icon-worker"+t+"-tab.svg");document.getElementById("worker"+t).src=s,this._.includes(this.selectFilteredBeaconsUpdateAfter,t)||this.selectFilteredBeaconsUpdateAfter.push(t.toString()),document.getElementById("worker"+t).onclick=()=>{this.bgChangeWorker(t)}},bgChangeWorker(t){var e=document.getElementById("worker"+t).src,s=e.replace("filter-icon-worker"+t+"-tab.svg","icon-worker"+t+".svg");document.getElementById("worker"+t).src=s,this._.forEach(this.selectFilteredBeaconsUpdateAfter,(e,s)=>{e===t.toString()&&this.selectFilteredBeaconsUpdateAfter.splice(s,1)}),document.getElementById("worker"+t).onclick=()=>{this.bgChangeWorkerTab(t)}},filterBeacons(){let t='<div class="filter_menu"><div>';var e=this.map.getCenter(),s={};e.y-=3,this.selectFilteredBeaconsUpdateAfter.length!=window.CONSTANTS.MINIMUM_NUMBER.FILTERED_BEACONS?this._.forEach(this.gadgetInfoNumber,e=>{this._.includes(this.selectFilteredBeaconsUpdateAfter,e)?t+='<img id="worker'+e+'" class="workerImg" src="'+window.CONSTANTS.URL.BASE_IMG+"filter-icon-worker"+e+'-tab.svg">':t+='<img id="worker'+e+'" class="workerImg" src="'+window.CONSTANTS.URL.BASE_IMG+"icon-worker"+e+'.svg" >'}):this._.forEach(this.gadgetInfoNumber,e=>{t+='<img id="worker'+e+'" class="workerImg" src="'+window.CONSTANTS.URL.BASE_IMG+"filter-icon-worker"+e+'-tab.svg">'}),t+='</div><div class="controlContainer"><button id="done" class="done">OK</button><button id="reset" class="reset">Reset</button></div></div>',s={width:700,height:220,autoPan:!0,autoCloseOn:!0,autoOpenOn:!0,content:t},this.infoWindow=new l["f"].InfoWindow(s),this.infoWindow.addTo(this.map).show(e),document.getElementById("clickbtnPlus").onclick=()=>{this.infoWindow.remove(),this.selectFilteredBeaconsUpdateAfter=this._.clone(this.selectFilteredBeaconsUpdateBefore)},document.getElementById("clickbtnMinus").onclick=()=>{this.infoWindow.remove(),this.selectFilteredBeaconsUpdateAfter=this._.clone(this.selectFilteredBeaconsUpdateBefore)},document.getElementsByClassName("maptalks-close")[0].onclick=()=>{this.refilterBeacons(),this.infoWindow.remove()},document.getElementsByClassName("done")[0].onclick=()=>{this.setFilteredBeacons(),this.infoWindow.remove(),this.selectFilteredBeaconsUpdateBefore=this._.clone(this.selectFilteredBeaconsUpdateAfter)},document.getElementsByClassName("reset")[0].onclick=()=>{this.refilterBeacons(),this.infoWindow.hide(),this.infoWindow.remove()},this._.forEach(this.gadgetInfoNumber,t=>{document.getElementById("worker"+t).onclick=()=>{this._.includes(this.selectFilteredBeaconsUpdateAfter,t)?this.bgChangeWorker(t,this.selectFilteredBeaconsUpdateAfter,()=>{}):this.bgChangeWorkerTab(t,this.selectFilteredBeaconsUpdateAfter,()=>{})}})},showLoading(){this.$emit("map-load",!0)},hideLoading(){this.$emit("map-load",!1)}},computed:{isEmptyUrl(){return this._.isEmpty(this.mapUrl)}},created(){this.$emit("select-button"),K.$on("zoomIn",()=>{this.map.zoomIn(7)}),K.$on("zoomOut",()=>{this.map.zoomOut(6)}),K.$on("filter",()=>{this.filterBeacons()})},mounted(){this.initloadMap()},mixins:[L]}),S=M,B=(s("54d9"),s("2877")),A=Object(B["a"])(S,c,r,!1,null,null,null),O=A.exports,H=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"topContainer"}},[s("div",{attrs:{id:"leftContainer"}},[s("div",{attrs:{id:"zoom"}},[s("img",{attrs:{id:"clickbtnPlus",src:"static/location/imgs/icon-plus.svg"},on:{click:t.zoomIn}}),s("img",{attrs:{id:"clickbtnMinus",src:"static/location/imgs/icon-minus.svg"},on:{click:t.zoomOut}})]),s("div",{attrs:{id:"filter"}},[s("img",{attrs:{id:"clickbtnFilter",src:"static/location/imgs/icon-filter.svg"},on:{click:t.filter}})])]),s("div",{attrs:{id:"rightContainer"}},[s("div",{attrs:{id:"upload"}},[s("button",{attrs:{id:"clickbtn"},on:{click:function(e){return t.$refs.file.click()}}},[t._m(0)]),s("input",{ref:"file",attrs:{type:"file",id:"file",accept:"image/jpeg, image/png, image/gif"},on:{change:t.onFileChange}})])])])},U=[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"btntitle"}},[t._v("Upload "),s("i",{staticClass:"fa fa-upload"})])}],G={name:"Top",methods:{zoomIn(){K.$emit("zoomIn")},zoomOut(){K.$emit("zoomOut")},onFileChange(t){this.file=t.target.files[0],this.submitFile()},getMapFile(t){this.services.getMapFile},submitFile(){this.services.postMapFile(this.file,t=>{window.location.reload()},t=>{console.warn("File upload failed")})},handleFileUpload(){this.file=this.$refs.file.files[0]},filter(){K.$emit("filter")}},computed:{isEmptyUrl(){return!this.url}},created(){this.getMapFile()}},$=G,W=(s("dee7"),Object(B["a"])($,H,U,!1,null,null,null)),F=W.exports,x={components:{Map:O,Top:F},data(){return{isLoaded:!1}},methods:{handleMapLoad(t){this.isLoaded=t}}},R=x,D=(s("034f"),Object(B["a"])(R,n,d,!1,null,null,null)),z=D.exports,P=s("415c"),Z=s.n(P),j=(s("5453"),s("2f62"));a["a"].use(j["a"]);var V=new j["a"].Store({state:{hubs:{},gadgets:{},detectedgadgets:{},forInfohubs:[],drawnHubs:{},ipcams:{}},getters:{getHubs:t=>{return _.values(t.hubs)},getHub:t=>e=>{if(!_.isEmpty(t.hubs[e]))return t.hubs[e];console.warn(`Theres no hub data in hubid ${e}`)},getHubsWhichIsInMap:t=>{return _.values(t.drawnHubs)},getBeaconWithHubs:t=>e=>{if(!_.isEmpty(t.forInfohubs[e]))return t.forInfohubs[e];console.warn(`Theres no hub data in hubid ${e}`)},getdetectedGadgetList:t=>{return t.detectedgadgets},getdetectedGadgetName:t=>e=>{return t.detectedgadgets[e]?t.detectedgadgets[e].name:""},getIpCams:t=>e=>{if(t.ipcams[e])return t.ipcams[e];console.warn(`Theres no ipcam data in ipcam id ${e}`)}},mutations:{addHubs(t,e){_.forEach(e,e=>{t.hubs[e.id]=e})},HubIsInMap(t,e){_.isEmpty(t.drawnHubs[e])&&(t.drawnHubs[e]={}),t.drawnHubs[e].id=e,t.drawnHubs[e].view=1},HubIsNotInMap(t,e){_.isEmpty(t.drawnHubs[e])&&(t.drawnHubs[e]={}),t.drawnHubs[e].id=e,t.drawnHubs[e].view=0},addDetectedGadget(t,e){_.forEach(e,e=>{t.gadgets[e.id]=e})},addDetectedHubGadget(t,e){_.forEach(e,s=>{if(_.has(t.gadgets,s.gid)){let i=t.gadgets[s.gid];_.isEmpty(t.detectedgadgets[s.gid])&&(t.detectedgadgets[s.gid]={gid:i.id,hubIdList:[],name:i.name,dist:s.dist,uuid:i.beacon_spec.uuid,major:i.beacon_spec.major,minor:i.beacon_spec.minor,custom:{},tags:i.tags,view:0,account_id:i.account_id}),t.forInfohubs[s.hid]=e,_.isEmpty(t.detectedgadgets[s.gid].hubIdList.find(t=>t===s.hid))&&t.detectedgadgets[s.gid].hubIdList.push(s.hid)}})},addHubLocation(t,e){let s=t.hubs[e.id];_.isEmpty(s)||(s.custom.map_location=e.custom.map_location)},addGadgetLocation(t,e){let s=t.gadgets[e.gid],i=t.detectedgadgets[e.gid];_.isEmpty(s)||_.isUndefined(i)||(s.custom=_.pick(e,["x","y"]),i.custom=_.pick(e,["x","y"]))},GadgetIsInMap(t,e){t.detectedgadgets[e]&&(t.detectedgadgets[e].view=window.CONSTANTS.HUB_VIEW.IN_MAP)},GadgetIsnotInMap(t,e){_.isEmpty(t.detectedgadgets[e])||(t.detectedgadgets[e].view=window.CONSTANTS.HUB_VIEW.NOT_IN_MAP)},removeGadgets(t){_.forEach(t.gadgets,(e,s)=>{t.gadgets[s]={},a["a"].delete(t.gadgets,s)}),_.forEach(t.detectedgadgets,(e,s)=>{t.detectedgadgets[s]={},a["a"].delete(t.detectedgadgets,s)})},removeHubs(t){_.forEach(t.forInfohubs,(e,s)=>{t.forInfohubs[s]={},a["a"].delete(t.forInfohubs,s)})},addIpcams(t,e){_.forEach(e,e=>{t.ipcams[e.id]=e})},updateIpcamData(t,e){t.ipcams[e.id]&&(t.ipcams[e.id]=e)}}});s("1aa9");s.d(e,"EventBus",function(){return K}),a["a"].prototype.$http=m.a,a["a"].prototype.services=i,a["a"].prototype.beaconDetector=o,a["a"].config.productionTip=!1;const K=new a["a"]({});a["a"].use(Z.a),new a["a"]({store:V,render:t=>t(z)}).$mount("#locationTracking")},"64a9":function(t,e,s){},b347:function(t,e,s){},dee7:function(t,e,s){"use strict";var i=s("1d68"),o=s.n(i);o.a}});
//# sourceMappingURL=app.3d1efef8.js.map