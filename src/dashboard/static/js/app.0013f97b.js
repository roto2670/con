(function(t){function e(e){for(var o,n,r=e[0],c=e[1],d=e[2],u=0,h=[];u<r.length;u++)n=r[u],i[n]&&h.push(i[n][0]),i[n]=0;for(o in c)Object.prototype.hasOwnProperty.call(c,o)&&(t[o]=c[o]);l&&l(e);while(h.length)h.shift()();return a.push.apply(a,d||[]),s()}function s(){for(var t,e=0;e<a.length;e++){for(var s=a[e],o=!0,r=1;r<s.length;r++){var c=s[r];0!==i[c]&&(o=!1)}o&&(a.splice(e--,1),t=n(n.s=s[0]))}return t}var o={},i={app:0},a=[];function n(e){if(o[e])return o[e].exports;var s=o[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=o,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(s,o,function(e){return t[e]}.bind(null,o));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/";var r=window["webpackJsonp"]=window["webpackJsonp"]||[],c=r.push.bind(r);r.push=e,r=r.slice();for(var d=0;d<r.length;d++)e(r[d]);var l=c;a.push([0,"chunk-vendors"]),s()})({0:function(t,e,s){t.exports=s("56d7")},"034f":function(t,e,s){"use strict";var o=s("64a9"),i=s.n(o);i.a},"1d68":function(t,e,s){},"54d9":function(t,e,s){"use strict";var o=s("b347"),i=s.n(o);i.a},"56d7":function(t,e,s){"use strict";s.r(e);var o={};s.r(o),s.d(o,"setHubLocation",function(){return g}),s.d(o,"getProductId",function(){return p}),s.d(o,"getHubs",function(){return b}),s.d(o,"getHubListConnectedToGadget",function(){return f}),s.d(o,"getBeacons",function(){return v}),s.d(o,"getDetectBeaconList",function(){return y}),s.d(o,"getGadgets",function(){return w}),s.d(o,"getGadget",function(){return k}),s.d(o,"getMapFiles",function(){return M}),s.d(o,"postMapFile",function(){return E});var i={};s.r(i),s.d(i,"BeaconDetector",function(){return G});var a=s("2b0e"),n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"locationTracking"}},[s("Top"),s("Map")],1)},r=[],c=function(){var t=this,e=t.$createElement,s=t._self._c||e;return t.isEmptyUrl?s("div",{staticClass:"container",attrs:{id:t.id}}):t._e()},d=[],l=s("ec60"),u=s("bc3a"),h=s.n(u);const m="http://127.0.0.1:5000",g=(t,e,s)=>{h.a.post(m+"/dash/hubs/location",{hub:t},{headers:{"Content-Type":"application/json"}}).then(t=>{}).catch(t=>{console.log("FAILURE!!",t)})},p=(t,e)=>{var s=null;h()({url:m+"/dash/info",method:"GET",responseType:"text"}).then(e=>{e.data?(s=e.data,t(s)):console.log("File is not exist")})},b=(t,e)=>{var s=[];h()({url:m+"/dash/scanner/list",method:"GET",responseType:"text"}).then(e=>{e.data?(s=e.data,t(s)):console.log("File is not exist")})},f=(t,e,s)=>{let o={};h()({url:m+"/dash/hubs/detected/"+t,method:"GET",responseType:"text"}).then(t=>{let s=t.data;s&&_.isArray(s.data)?(o=s,e(o)):console.log("fail to load connectedGadget")})},v=(t,e,s)=>{var o=[];h()({url:m+"/dash/beacons/list/"+t,method:"GET",responseType:"text"}).then(t=>{t.data?(o=t.data,e(o)):console.log("File is not exist")})},y=(t,e,s)=>{let o={};h()({url:m+"/dash/beacons/detected/"+t,method:"GET",responseType:"text"}).then(t=>{let i=t.data;i&&_.isArray(i.data)?(o=i.data,e(o)):s()})},w=(t,e,s)=>{let o=[];x(t,o,()=>{e(o)})},k=(t,e,s)=>{h()({url:m+"/dash/beacons/"+t,method:"GET",responseType:"text"}).then(o=>{o.data?e(o.data):s(`Failed to get gadget, id: ${t}`)})},M=(t,e)=>{h()({url:m+"/dashboard/location/view",method:"GET",responseType:"text"}).then(e=>{e.data?(console.log("Success to Get map image file"),t("http://"+window.location.host+e.data)):console.log("Sorry, Img file does not exist")})},E=(t,e,s)=>{let o=new FormData;t&&(o.append("file",t),h.a.post(m+"/dashboard/location/upload",o,{headers:{"Content-Type":"multiart/form-data"}}).then(t=>{console.log("Success to Upload map image file"),e("http://"+window.location.host+t.data)}).catch(t=>{console.log("Fail to Upload map image file")}))};function x(t,e,s){let o=t.shift();o?k(o,o=>{e.push(o),x(t,e,s)},()=>{x(t,e,s)}):s()}const H=1e7;let T=null;class G{constructor(t,e){if(T)return T;this._timers=[],this.hubIds=[],this.isRunning=!1,this._vm=t,this._detectedCallback=e||function(){},T=this}start(){this.isRunning&&(this.isRunning=!0),this._timers.push(setInterval(()=>{this._refreshBeacons()},H)),console.info("Beacon detector started")}stop(){this._clearTimer(),this.isRunning=!1,console.info("Beacon detector stopped")}_refreshBeacons(){let t=this._vm.$store.getters.getHubs;this._vm._.forEach(t,t=>{y(t.id,t=>{this._vm.$store.commit("addGadget",t),this._detectedCallback(t)},t=>{console.warn("Failed to refresh beacons.",t)})})}_clearTimer(){this._.forEach(this._timers,t=>{try{clearInterval(t)}catch(e){console.warn("Failed to clear detector timer.",e)}}),this._timers=[]}}var $={methods:{isNumber:t=>!_.isNaN(t)&&_.isNumber(t)}},I={name:"Map",data(){return{id:"map",map:null,point:null,url:"",layer:"",hubLayer:"",workerLayer:"",camLayer:"",ipcam:"",ipcams:[],contextCoordinate:null,contextMenu:null,filtercontextMenu:null,bcns:{},options:{items:[]},markerMap:{hubs:{},gadgets:{},cams:{}}}},methods:{initloadMap(){this.services.getMapFiles(t=>{console.log("url : "+t),this.url=t,this.map=new l["c"](this.id,{center:[90,50],zoom:6,maxZoom:9,minZoom:5,maxExtent:new l["a"](5,5,170,80),zoomAnimation:!1,zoomInCenter:!0,panAnimation:!1,dragRotate:!1,dragPitch:!1,drgaRotatePitch:!1,touchGesture:!1,touchZoom:!1,touchRotate:!1,touchPitch:!1,touchZoomRotate:!1,doubleClickZoom:!1,baseLayer:new l["b"]("base",[{url:"static/location/imgs/map.png",extent:[0,0,180,85],opactiy:1}],{opactiy:1})}),this.layer=new l["e"]("vector").addTo(this.map),this.hubLayer=new l["e"]("vector1").addTo(this.map),this.workerLayer=new l["e"]("vector2").addTo(this.map),this.camLayer=new l["e"]("vector3").addTo(this.map),this.initBeaconLocationHandler(),this.initContextMenu(),this.loadHubs(),this.setIpcam()})},initBeaconLocationHandler(){this.beaconDetector=new G(this,t=>{}),this.beaconDetector.start()},initContextMenu(){this.contextMenuOption={items:[{item:"Add Scanner",click:this.handleAddHub}]},this.contextMenu=this.map.setMenu(this.contextMenuOption).openMenu(),this.map.closeMenu(),this.map.on("contextmenu",t=>{this.contextCoordinate=t.coordinate,this.map.openMenu(t.coordinate)})},loadHubs(){console.debug("Try load hubs"),this.services.getProductId(t=>{this.services.getBeacons(t.product_id,t=>{this.$store.commit("addDetectedGadget",t),this._loadHubs()})})},_loadHubs(){this.services.getHubs(t=>{console.log("Load hubs.",t),this.$store.commit("addHubs",t);const e=this.$store.getters.getHubs;this._.forEach(e,t=>{_.isEmpty(t.custom)||this.drawHub(t.id,t.custom.map_location)})})},loadGadgets(t,e,s){this.services.getDetectBeaconList(t,t=>{this.$store.commit("addDetectedHubGadget",t),this.hasSameGadget(e)},t=>{s(t)})},handleAddHub(t){this.showhubList(t=>{this.map.closeMenu(t),this.drawHub(t,this.contextCoordinate)})},showhubList(t){this.map.closeMenu(),this.services.getHubs(e=>{if(this.$store.commit("addHubs",e),this.options.items=[],!this._.isEmpty(e)){const s=new l["d"]([this.contextCoordinate.x,this.contextCoordinate.y]).addTo(this.hubLayer);s.hide(),this._.forEach(e,(s,o)=>{if(!_.has(this.markerMap.hubs,s.id))if(s.custom&&s.custom.map_location)console.debug(`The ${s.name} hub has location data. so skip`);else{const i={item:s.name,click:()=>{t(s.id)}};e.length-o>1?this.options.items.push(i,"-"):this.options.items.push(i)}}),s.setMenu(this.options).openMenu()}},function(t){console.warn("Failed to load hub list.")})},drawHubs(t){this._.isArray(t)?this._.forEach(t,function(t){this.drawHub(t.id,t.coordinate)}):console.warn("Failed to draw hubs by given id is empty or null.")},drawHub(t,e){console.debug("Try draw hub, id: ",t);let s=new l["d"]([e.x,e.y],{symbol:{markerFile:"static/location/imgs/icon-hub.svg",markerWidth:50,markerHeight:50}}).addTo(this.hubLayer);s.on("click",()=>{s.updateSymbol({markerFile:"static/location/imgs/icon-hub-tab.svg"}),this.showHubInfoWindow(t,s)}),this.markerMap.hubs[t]=s,this.loadGadgets(t,()=>{this.drawWorkers(t,e),this._updateHubLocation(t,e.x,e.y),this.startInterval(t),s.on("dragstart draaging dragend",e=>{var o=document.getElementsByClassName("hub-move-button")[0].innerHTML,i=o.replace("Move","SetLocation");document.getElementsByClassName("hub-move-button")[0].innerHTML=i,document.getElementsByClassName("hub-move-button")[0].onclick=(()=>{s.closeInfoWindow(),s.updateSymbol({markerFile:"static/location/imgs/icon-hub.svg"}),s.config("draggable",!1),this.removeGadgetMarkers(t),this.drawWorkers(t,s._coordinates)})})},t=>{console.log("load gadgets failed",t)})},removeHubMarker(t){console.debug(`Try remove hub marker, id: ${t}`);let e=this.markerMap.hubs[t];if(this._.isEmpty(e))console.warn(`Failed to remove hub marker, cannot find marker by given id: ${t}`);else{let s=this.$store.getters.getHub(t);this._.isEmpty(s)?console.warn(`Failed to clear hub location, cannot found hub model by given id: ${t}`):(delete s.custom.map_location,this.services.setHubLocation(s)),e.remove()}this.removeGadgetMarkers(t),delete this.markerMap.hubs[t]},removeGadgetMarkers(t){console.log(`Try remove hub markers for id: ${t}`);let e=this.markerMap.gadgets[t];this._.isEmpty(e)?console.warn(`Failed to remove gadget markers by given id: ${t}`):this._.forEach(e,t=>{t.remove()}),delete this.markerMap.gadgets[t]},showHubInfoWindow(t,e){let s="",o=null,i={};const a=this.$store.getters.getBeaconWithHubs(t),n=this.$store.getters.getHub(t);this._.isEmpty(a)?(s+="<li>Theres no gadget to load</li>",o+=0):this._.forEach(a,t=>{if(!i[t.gid]){i[t.gid]={};var e=this.$store.getters.getdetectedGadgetName(t.gid);s+=`<li>${e}</li>`}o=_.keys(i).length}),e.setInfoWindow({content:'<ul class="worker_menu"><div class="worker"><div class="workerId"><div class="workerkey">SCANNER</div>'+n.name+'</div><div class="workerCount"><div class="workerkey">WORKER</div>'+o+'</div><button class="hub-move-button">Move</button><button class="hub-remove-button">Remove</button></div><ul class="workerInfo">'+s+"</ul></ul>",width:350}),e.openInfoWindow(),document.getElementsByClassName("hub-move-button")[0].onclick=(()=>{e.config("draggable",!0)}),document.getElementsByClassName("hub-remove-button")[0].onclick=(()=>{this.removeHubMarker(t)}),document.getElementsByClassName("maptalks-close")[0].onclick=(()=>{e.updateSymbol({markerFile:"static/location/imgs/icon-hub.svg"}),e.config("draggable",!1)})},drawWorkers(t,e){let s=_.values(this.$store.getters.getdetectedGadgetList);this._.forEach(s,(s,o)=>{let i=null;this._.isEmpty(s.custom)?i=new l["d"]([e.x+o+1.5,e.y],{symbol:{markerFile:"static/location/imgs/icon-worker"+Math.ceil(16*Math.random())+".svg",markerWidth:50,markerHeight:50}}).addTo(this.workerLayer):(console.log("beaconsvcustom",s.hid,s.custom),i=new l["d"]([s.custom.x,s.custom.y],{symbol:{markerFile:"static/location/imgs/icon-worker"+Math.ceil(16*Math.random())+".svg",markerWidth:50,markerHeight:50}}).addTo(this.workerLayer)),i.on("click",()=>{i.updateSymbol({markerFile:"static/location/imgs/icon-worker"+Math.ceil(16*Math.random())+"-tab.svg"}),this.showGadgetInFoWindow(t,s.gid,this.bcns[o])}),this.bcns[o]=i;let a=this.markerMap.gadgets[t];a||(a=[],this.markerMap.gadgets[t]=a),a.push(i)})},showGadgetInFoWindow(t,e,s){let o=this.$store.getters.getdetectedGadgetList[e];s.setInfoWindow({content:'<div class="bcns"><div class="bcnsInfo"><div class="bcnskey">Name</div><div class="bcnName">'+(o.name||"no name")+'</div></div><img class="bcnsImg" src="static/location/imgs/item.png"></img></div>',width:400,bottom:11}),s.openInfoWindow(),document.getElementsByClassName("maptalks-close")[0].onclick=(()=>{s.updateSymbol({markerFile:"static/location/imgs/icon-worker"+Math.ceil(16*Math.random())+".svg"})})},setIpcam(){},setIpcamWindow(){this.ipcam.setInfoWindow({content:'<div class="bcns"><div class="bcnsInfo"><div class="bcnskey">IPCAM</div></div><img class="bcnsImg" src="static/location/imgs/item.png"></img></div>',width:400}),this.ipcam.openInfoWindow()},_updateHubLocation(t,e,s){let o=this.$store.getters.getHub(t);o&&e&&s?(this._.extend(o,{custom:{map_location:{x:e,y:s}}}),this.$store.commit("addHubLocation",o),this.services.setHubLocation(o),console.log("success to set hub location")):console.warn("Failed to update hub location, given parms cannot be null.",o,e,s)},startInterval(t){const e=1e7;setInterval(()=>{this.$store.commit("removeGadgets");const e=this.$store.getters.getHub(t);this.removeGadgetMarkers(e.id),_.isEmpty(e.id)?console.warn("There is no hub id, so we cannot update hub data"):this.drawWorkers(e.id,e.custom.map_location)},e)},setGadgetLocation(t){let e={},s={},o=0,i=0,a=null;this._.forEach(t,t=>{const s=this.$store.getters.getHub(t.hid);a=t.gid,s&&!this._.isEmpty(s.custom)?(e[t.hid]=s.custom.map_location,e[t.hid].dist=t.dist):console.warn(`There is empty custom in hubid: ${t.hid}`)}),this._.forEach(e,(t,e)=>{if(this.isNumber(t.dist)){let e=t.x,s=t.y;e+=e*(Math.abs(t.dist)/200),s+=s*(Math.abs(t.dist)/200),o+=e,i+=s}else console.warn(`There is no dist data in hubId: ${e}`)}),this._.isEmpty(e)||(this._.forEach(t,t=>{this._.forEach(t,t=>{s={hid:t,gid:a,x:o/this._.size(e),y:i/this._.size(e)}})}),this.$store.commit("addGadgetLocation",s))},hasSameGadget(t){const e=this.$store.getters.getgadgetmanyhubs;let s={};this._.forEach(e,(t,e)=>{t.length>1&&(s[e]={},s[e]=t)});let o=_.keys(s).length,i=1;console.log("samegadgetlsit",s),0==o?t():this._.forEach(s,(e,s)=>{this.services.getHubListConnectedToGadget(s,e=>{this.setGadgetLocation(e.data),o==i?t():i++})})},filterBeacons(){this.$store.getters.getdetectedGadgetList;this.filtercontextMenu={custom:!0,items:'<ul class="custom_menu"></ul>'},this.filtercontextMenu=this.map.setMenu(this.filtercontextMenu).openMenu(),this.map.on("contextmenu",t=>{this.map.openMenu(t.coordinate)})}},computed:{isEmptyUrl(){return this._.isEmpty(this.mapUrl)}},created(){this.$emit("select-button"),q.$on("zoomIn",()=>{this.map.zoomIn(7)}),q.$on("zoomOut",()=>{this.map.zoomOut(6)}),q.$on("filter",()=>{this.filterBeacons()})},mounted(){this.initloadMap()},mixins:[$]},L=I,F=(s("54d9"),s("2877")),C=Object(F["a"])(L,c,d,!1,null,null,null),B=C.exports,W=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"container",attrs:{id:"topContainer"}},[s("div",{staticClass:"subContainer",attrs:{id:"zoom"}},[s("img",{attrs:{id:"clickbtnPlus",src:"static/location/imgs/icon-plus.svg"},on:{click:t.zoomIn}}),s("img",{attrs:{id:"clickbtnMinus",src:"static/location/imgs/icon-minus.svg"},on:{click:t.zoomOut}})]),s("div",{staticClass:"subContainer",attrs:{id:"upload"}},[s("button",{attrs:{id:"clickbtn"},on:{click:function(e){return t.$refs.file.click()}}},[t._m(0)]),s("input",{ref:"file",attrs:{type:"file",id:"file",accept:"image/jpeg, image/png, image/gif"},on:{change:t.onFileChange}})])])},O=[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"btntitle"}},[t._v("Upload "),s("i",{staticClass:"fa fa-upload"})])}],S={name:"Top",methods:{zoomIn(){q.$emit("zoomIn")},zoomOut(){q.$emit("zoomOut")},onFileChange(t){this.file=t.target.files[0],this.submitFile()},getMapFile(t){this.services.getMapFile},submitFile(){this.services.postMapFile(this.file,t=>{console.log("adadada",t)})},handleFileUpload(){this.file=this.$refs.file.files[0]}},computed:{isEmptyUrl(){return!this.url}},created(){this.getMapFile()}},N=S,z=(s("dee7"),Object(F["a"])(N,W,O,!1,null,null,null)),j=z.exports,P={components:{Map:B,Top:j},methods:{}},R=P,A=(s("034f"),Object(F["a"])(R,n,r,!1,null,null,null)),D=A.exports,U=s("415c"),Z=s.n(U),J=(s("5453"),s("2f62"));a["a"].use(J["a"]);var K=new J["a"].Store({state:{hubs:{},gadgets:{},detectedgadgets:{},forInfohubs:[],drawgadget:{}},getters:{getHubs:t=>{return _.values(t.hubs)},getHub:t=>e=>{return t.hubs[e]},getBeaconWithHubs:t=>e=>{return t.forInfohubs[e]},getGadget:t=>(e,s)=>{return t.gadgets[e].find(t=>t.id===s)},getGadgetsWithHub:t=>{return t.gadgets},getdetectedGadgetList:t=>{return t.detectedgadgets},getdetectedGadgetName:t=>e=>{return t.detectedgadgets[e].name},getgadgetmanyhubs:t=>{let e={};return _.forEach(t.detectedgadgets,t=>{e[t.gid]={},e[t.gid]=t.hid}),e}},mutations:{addHubs(t,e){_.forEach(e,e=>{t.hubs[e.id]=e})},addHub(t,e){_.isEmpty(t.hubs[e.hub_id])&&(t.hubs[e.hub_id]=[]),t.hubs[e.hub_id].push(e.hub)},addDetectedGadget(t,e){_.forEach(e,e=>{t.gadgets[e.id]=e})},addDetectedHubGadget(t,e){_.forEach(e,s=>{if(_.has(t.gadgets,s.gid)){let o=t.gadgets[s.gid];_.isEmpty(t.detectedgadgets[s.gid])&&(t.detectedgadgets[s.gid]={gid:o.id,hid:[],name:o.name,dist:s.dist,uuid:o.beacon_spec.uuid,major:o.beacon_spec.major,minor:o.beacon_spec.minor,custom:{}}),t.forInfohubs[s.hid]=e,_.isEmpty(t.detectedgadgets[s.gid].hid.find(t=>t===s.hid))&&t.detectedgadgets[s.gid].hid.push(s.hid)}})},addGadgets(t,e){_.forEach(e,e=>{t.gadgets[e.id]=e})},addHubLocation(t,e){const s=t.hubs[e.id];_.isEmpty(s)||(s.custom.map_location=e.custom.map_location)},addGadgetLocation(t,e){const s=t.gadgets[e.gid],o=t.detectedgadgets[e.gid];_.isEmpty(s)?console.warn("GadgetList is Empty"):(s.custom=_.pick(e,["x","y"]),o.custom=_.pick(e,["x","y"]))},removeGadgets(t){t.gadgets={}}},actions:{}});s.d(e,"EventBus",function(){return q}),a["a"].prototype.$http=h.a,a["a"].prototype.services=o,a["a"].prototype.beaconDetector=i,a["a"].config.productionTip=!1;const q=new a["a"]({});a["a"].use(Z.a),new a["a"]({store:K,render:t=>t(D)}).$mount("#locationTracking")},"64a9":function(t,e,s){},b347:function(t,e,s){},dee7:function(t,e,s){"use strict";var o=s("1d68"),i=s.n(o);i.a}});
//# sourceMappingURL=app.0013f97b.js.map