{% extends "base_site.html" %}

{% block sidebar %}
    <div class="nav_sidebar_hidden col-md-3 left_col {% block sidebar_class %} {% endblock sidebar_class %}">
        {% include "site_template/sidebar_covid19.html" %}
    </div>
{% endblock sidebar %}

{% block stylesheets %}
    {{ super() }}
    <link type="text/css" rel="stylesheet" href="static/css/common.css">
    <link type="text/css" rel="stylesheet" href="static/css/notifications.css">
{% endblock stylesheets %}

{% block title %}{% endblock title %}

{% block content %}
<div id="scroll-style-hidden" class="right_col base" role="main">
    <div class="top-container">
        {% if current_user.level in [0, 7] %}
        <div class="top-button admin">
            <div class="top-button-icon">
                <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4.67458 1.4059L3.33333 3.08256L1.99208 1.4059C1.93791 1.33893 1.86435 1.29036 1.78149 1.26684C1.69863 1.24332 1.61052 1.24601 1.52925 1.27453C1.44797 1.30305 1.37751 1.35601 1.32752 1.42615C1.27752 1.49629 1.25045 1.58018 1.25 1.66631V7.91631C1.25 8.37589 1.62375 8.74964 2.08333 8.74964H7.91667C8.37625 8.74964 8.75 8.37589 8.75 7.91631V1.66631C8.74955 1.58018 8.72248 1.49629 8.67248 1.42615C8.62249 1.35601 8.55203 1.30305 8.47075 1.27453C8.38948 1.24601 8.30137 1.24332 8.21851 1.26684C8.13565 1.29036 8.06209 1.33893 8.00792 1.4059L6.66667 3.08256L5.32542 1.4059C5.16667 1.2084 4.83333 1.2084 4.67458 1.4059ZM2.08333 7.91631V7.08298H7.91708V7.91631H2.08333ZM6.34125 4.01006C6.5 4.20798 6.83375 4.20798 6.9925 4.01006L7.91667 2.85423L7.91708 6.24964H2.08333V2.85423L3.00792 4.01006C3.16667 4.20798 3.50042 4.20798 3.65917 4.01006L5 2.3334L6.34125 4.01006Z" fill="white"/>
                </svg>
            </div>
            <div class="top-button-label">Admin</div>
        </div>
        {% endif %}
        <div class="top-button medical">
            <div class="top-button-icon">
                <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2.63687 1.875L2.54875 2.02187C2.54875 2.02187 1.5625 3.64125 1.5625 6.25V6.5625H3.46687C3.44645 6.66539 3.43661 6.7701 3.4375 6.875C3.4375 7.73438 4.14062 8.4375 5 8.4375C5.85938 8.4375 6.5625 7.73438 6.5625 6.875C6.5625 6.7675 6.55406 6.66406 6.53312 6.5625H8.4375V6.25C8.4375 4.80938 8.195 3.75313 7.94906 3.05625C7.70344 2.36 7.44125 2.00188 7.44125 2.00188L7.34375 1.875H2.63656H2.63687ZM3.0175 2.5H6.9925C7.03781 2.565 7.17156 2.72875 7.36312 3.27188C7.56625 3.84688 7.74813 4.75 7.78312 5.9375H6.25C5.96406 5.55938 5.5075 5.3125 5 5.3125C4.4925 5.3125 4.03594 5.55938 3.75 5.9375H2.21687C2.28812 3.85938 2.91438 2.67813 3.0175 2.5ZM4.6875 3.125V3.75H4.0625V4.375H4.6875V5H5.3125V4.375H5.9375V3.75H5.3125V3.125H4.6875ZM5 5.9375C5.52187 5.9375 5.9375 6.35313 5.9375 6.875C5.9375 7.39688 5.52187 7.8125 5 7.8125C4.47813 7.8125 4.0625 7.39688 4.0625 6.875C4.0625 6.35313 4.47813 5.9375 5 5.9375ZM5 6.5625C4.91712 6.5625 4.83763 6.59542 4.77903 6.65403C4.72042 6.71263 4.6875 6.79212 4.6875 6.875C4.6875 6.95788 4.72042 7.03737 4.77903 7.09597C4.83763 7.15458 4.91712 7.1875 5 7.1875C5.08288 7.1875 5.16237 7.15458 5.22097 7.09597C5.27958 7.03737 5.3125 6.95788 5.3125 6.875C5.3125 6.79212 5.27958 6.71263 5.22097 6.65403C5.16237 6.59542 5.08288 6.5625 5 6.5625Z" fill="white"/>
                </svg>
            </div>
            <div class="top-button-label">Clinic</div>
        </div>
        <div class="top-button sent">
            <div class="top-button-icon">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6.5 8.5H8.5V7L11 9.25L8.5 11.5V10H6.5V8.5ZM10 2H2C1.73478 2 1.48043 2.10536 1.29289 2.29289C1.10536 2.48043 1 2.73478 1 3V9C1 9.26522 1.10536 9.51957 1.29289 9.70711C1.48043 9.89464 1.73478 10 2 10H5.5V9H2V4L6 6.5L10 4V7H11V3C11 2.73478 10.8946 2.48043 10.7071 2.29289C10.5196 2.10536 10.2652 2 10 2ZM6 5.5L2 3H10L6 5.5Z" fill="#EF8009"/>
                </svg>
            </div>
            <div class="top-button-label">Sent</div>
        </div>

        {% if current_user.level in [0, 7] %}
        <div class="top-button compliance">
            <div class="top-button-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="512px" viewBox="0 0 24 24" width="512px">
                    <path d="m21.5 24h-19c-1.379 0-2.5-1.121-2.5-2.5v-19c0-1.379 1.121-2.5 2.5-2.5h19c1.379 0 2.5 1.121 2.5 2.5v19c0 1.379-1.121 2.5-2.5 2.5zm-19-23c-.827 0-1.5.673-1.5 1.5v19c0 .827.673 1.5 1.5 1.5h19c.827 0 1.5-.673 1.5-1.5v-19c0-.827-.673-1.5-1.5-1.5z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#FFFFFF"/>
                    <path d="m8.5 11h-4c-.827 0-1.5-.673-1.5-1.5v-4c0-.827.673-1.5 1.5-1.5h4c.827 0 1.5.673 1.5 1.5v4c0 .827-.673 1.5-1.5 1.5zm-4-6c-.275 0-.5.225-.5.5v4c0 .275.225.5.5.5h4c.275 0 .5-.225.5-.5v-4c0-.275-.225-.5-.5-.5z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#FFFFFF"/>
                    <path d="m20.5 6h-7c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h7c.276 0 .5.224.5.5s-.224.5-.5.5z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#FFFFFF"/>
                    <path d="m20.5 10h-7c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h7c.276 0 .5.224.5.5s-.224.5-.5.5z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#FFFFFF"/>
                    <path d="m6.5 9c-.128 0-.256-.049-.354-.146l-2-2c-.195-.195-.195-.512 0-.707s.512-.195.707 0l1.647 1.646 4.646-4.646c.195-.195.512-.195.707 0s.195.512 0 .707l-5 5c-.097.097-.225.146-.353.146z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#FFFFFF"/>
                    <path d="m8.5 21h-4c-.827 0-1.5-.673-1.5-1.5v-4c0-.827.673-1.5 1.5-1.5h4c.827 0 1.5.673 1.5 1.5v4c0 .827-.673 1.5-1.5 1.5zm-4-6c-.275 0-.5.225-.5.5v4c0 .275.225.5.5.5h4c.275 0 .5-.225.5-.5v-4c0-.275-.225-.5-.5-.5z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#FFFFFF"/>
                    <path d="m20.5 16h-7c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h7c.276 0 .5.224.5.5s-.224.5-.5.5z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#FFFFFF"/>
                    <path d="m20.5 20h-7c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h7c.276 0 .5.224.5.5s-.224.5-.5.5z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#FFFFFF"/>
                </svg>
            </div>
            <div class="top-button-label">Observations</div>
        </div>
        {% endif %}
    </div>
    <div class="content-container"></div>

    <div class="noty-item-loader-btn loading">
        <div class="noty-item-loader-icon"></div>
        <div class="noty-item-loader-label">Load more</div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
    {{ super() }}

    <script>
        (function() {
            const PAGE_SIZE = 10, // chunk size
                MESSAGE_TYPE = {
                    ADMIN: 'admin',
                    MEDICAL: 'medical',
                    SENT: 'sent',
                    COMPLIANCE: 'compliance'
                },
                MESSAGE_ACTION = {
                    SELF_ASSESSMENT: 1,
                    REPORT_TEST_RESULTS: 2,
                    REPLY: 3,
                    REPLY_IN_USERS: 4,
                    CLINIC: 5,
                    NONE: 0
                },
                USER_MENU_URL_PREFIX='users';
            const DOWNLOAD_URL_BUILDER = _.template('https://skec-fujairah.loc8.dev:10443/api/download/file/<%= id %>');

            let _db = firebase.firestore(),
                _currentUser = null;
            let _lastQuerySnapShots = {},
                _loadingMessages = false
                _notyItemContainers = {}
                _currentMessageType = ''
                _initializedSnapshotHandler = false;
                _initializedComplianceSnapshotHandler = false;
            let _messageItems = {},
                _complianceItems = {};

            
            // init
            initHandlers();
            render();
            switchMessages(MESSAGE_TYPE.ADMIN, function() {
                initSnapshotHandler();
            });

            function initHandlers() {
                // init top buttons.
                $('.top-button.admin').click(function() {
                    switchMessages(MESSAGE_TYPE.ADMIN);
                });
                $('.top-button.medical').click(function() {
                    switchMessages(MESSAGE_TYPE.MEDICAL);
                });
                $('.top-button.sent').click(function() {
                    switchMessages(MESSAGE_TYPE.SENT);
                });
                $('.top-button.compliance').click(function() {
                    switchMessages(MESSAGE_TYPE.COMPLIANCE);
                });

                $('.noty-item-loader-btn').click(function() {
                    let _this = $(this);
                    _this.addClass('loading');
                    displayMessages(_currentMessageType, true, function (empty) {
                        _this.removeClass('loading');
                        if (empty) {
                            _this.addClass('hide');
                        }
                    });
                });
            }

            function initSnapshotHandler() {
                // Add message item in real time.
                _db.collection('messages')
                    .orderBy('ts', 'desc')
                    .limit(1)
                    .onSnapshot(function(snapshot) {
                        if (!_initializedSnapshotHandler) {
                            // FIXME: OnSnapshot first loads all the documents that match the query.
                            _initializedSnapshotHandler = true;
                            return;
                        }
                        snapshot.docChanges().forEach(function(change) {
                            if (change.type === 'added') {
                                let container,
                                    model;

                                model = change.doc.data();
                                model.documentId = change.doc.id;
                                if (model && model.action != MESSAGE_ACTION.REPLY && model.action != MESSAGE_ACTION.REPLY_IN_USERS) {
                                    // don't check type of type.
                                    // check type
                                    if (model.to_user == 1) {
                                        // admin
                                        container = _notyItemContainers[MESSAGE_TYPE.ADMIN];
                                    } else if (model.to_user == 2) {
                                        // medical team
                                        container = _notyItemContainers[MESSAGE_TYPE.MEDICAL];
                                    } else if (model.from_user == 1 || model.from_user == 2) {
                                        // sent
                                        container = _notyItemContainers[MESSAGE_TYPE.SENT];
                                    }

                                    if (!!container) {
                                        let item = MessageItem(model, {
                                            goToUser: function(userId) {
                                                goToUserMenu(userId);
                                            },
                                            selectedMessage: function(message) {
                                                showMessageDialog(message);
                                            }
                                        });

                                        // do animation
                                        _.delay(function() {
                                            container.prepend(item.render());
                                            item.blink();
                                        });

                                        // Store
                                        _messageItems[model.documentId] = {
                                            model: model,
                                            viewItem: item
                                        };
                                    } else {
                                        // this message will be appered when switched view.
                                    }
                                }
                            } 
                            {# else if (change.type === 'modified') {
                                let _model,
                                    _data = _messageItems[change.doc.id];
                                    
                                if (_data) {
                                    _model = change.doc.data();

                                    // Updates view item
                                    _data.model = _model;
                                    _data.viewItem.update(_model);
                                }
                            } #}
                        });
                    });

                _db.collection('compliance_reports')
                    .orderBy('ts', 'desc')
                    .limit(1)
                    .onSnapshot(function(snapshot) {
                        snapshot.docChanges().forEach(function(change) {
                            if (!_initializedComplianceSnapshotHandler) {
                                // FIXME: OnSnapshot first loads all the documents that match the query.
                                _initializedComplianceSnapshotHandler = true;
                                return;
                            }

                            if (change.type === 'added') {
                                let container,
                                    model;

                                model = change.doc.data();
                                model.documentId = change.doc.id;
                                model.fromUserId = change.from_user.id;
                                if (model) {
                                    // don't check type of type.
                                    container = _notyItemContainers[MESSAGE_TYPE.COMPLIANCE];
                                    if (!!container) {
                                        let item = ComplianceMessageItem(model, {
                                            goToUser: function(userId) {
                                                goToUserMenu(userId);
                                            },
                                            selectedMessage: function(message) {
                                                showComplianceMessageDialog(message, 5);
                                            },
                                            selectedResolve: function(message) {
                                                showComplianceResolveDialog(message);
                                            }
                                        });

                                        // do animation
                                        _.delay(function() {
                                            container.prepend(item.render());
                                            item.blink();
                                        });

                                        // Store in cache
                                        _complianceItems[model.documentId] = {
                                            model: model,
                                            viewItem: item
                                        }
                                    } else {
                                        // this message will be appered when switched view.
                                    }
                                }
                            }
                             {# else if (change.type === 'modified') {
                                let model = change.doc.data();
                                model.documentId = change.doc.id;

                                if (snapshot.metadata.hasPendingWrites) {
                                    // This has not yet been recorded on the server, so must manually set the time field.
                                    model.ts = {
                                        seconds: new Date().getTime() / 1000
                                    };
                                }

                                let data = _complianceItems[model.documentId];
                                if (data) {
                                    data.model = model;
                                    data.viewItem.update(model);
                                }
                            } #}
                        });
                    });
            }

            function render() {
                _.each(MESSAGE_TYPE, function(type) {
                    _notyItemContainers[type] = $('<div class="noty-item-container ' + type + '">');
                })

                // init Pnotify
                PNotify.prototype.options.delay = 5000;
                PNotify.prototype.options.styling = 'bootstrap3';
            }

            function goToUserMenu(id) {
                if (!!id) {
                    window.location = USER_MENU_URL_PREFIX + '?id=' + encodeURIComponent(id);
                }
            }

            function switchMessages(type, callback, force) {
                let _callback = callback || _.noop;

                $('.noty-item-loader-btn').addClass('loading').removeClass('hide');
                if (_currentMessageType !== type || force) {
                    let currentContainer = _notyItemContainers[type];

                    $('.top-button').removeClass('selected');
                    $('.top-button.' + type).addClass('selected');
                    _.each(_notyItemContainers, function(container) {
                        container.detach();
                    })
                    currentContainer.appendTo($('.content-container'));
                    if (force) {
                        currentContainer.empty();
                        _lastQuerySnapShots[type] = null;
                    }
                    if (!!currentContainer && currentContainer.children().length <= 0) {
                        // Load init messages
                        displayMessages(type, false, function(empty) {
                            $('.noty-item-loader-btn').removeClass('loading');
                            if (empty) {
                                $('.noty-item-loader-btn').addClass('hide');
                            }
                            _callback();
                        });
                    } else {
                        $('.noty-item-loader-btn').removeClass('loading');
                        _callback();
                    }
                    _currentMessageType = type;
                } else {
                    // nothing.
                    $('.noty-item-loader-btn').removeClass('loading');
                    _callback();
                }
            }

            function displayMessages(type, animation, callback) {
                var _callback = callback || _.noop;
                if (!_loadingMessages) {
                    _loadingMessages = true;
                    loadMessages(_lastQuerySnapShots[type], type, function(messages, lastSnapShot) {
                        // TODO: check last snapshot is equal?
                        if (!!lastSnapShot) {
                            _lastQuerySnapShots[type] = lastSnapShot;
                        } else {
                            // TODO no more items.
                        }

                        // render messages.
                        let container = _notyItemContainers[type];
                        $.each(messages, function(index, message) {
                            let item;
                            if (MESSAGE_TYPE.COMPLIANCE != type) {
                                item = MessageItem(message, {
                                    goToUser: function(userId) {
                                        goToUserMenu(userId);
                                    },
                                    selectedMessage: function(message) {
                                        showMessageDialog(message);
                                    }
                                });

                                // Store in cache.
                                _messageItems[message.documentId] = {
                                    model: message,
                                    viewItem: item
                                };
                            } else {
                                item = ComplianceMessageItem(message, {
                                    goToUser: function(userId) {
                                        goToUserMenu(userId);
                                    },
                                    selectedMessage: function(message) {
                                        showComplianceMessageDialog(message, 5);
                                    },
                                    selectedResolve: function(message) {
                                        showComplianceResolveDialog(message);
                                    }
                                });

                                // Store in cache
                                _complianceItems[message.documentId] = {
                                    model: message,
                                    viewItem: item
                                }
                            }
                            container.append(item.render());
                            if (animation) {
                                item.blink();
                            }
                        });

                        _loadingMessages = false;
                        _callback(!!!lastSnapShot || (messages && messages.length < PAGE_SIZE));
                    });
                } else {
                    console.debug("Already loading messages.");
                    _callback();
                }
            }

            function loadMessages(startAt, type, callback) {
                var ref = _db.collection('messages');

                // create a query.
                var query;
                if (MESSAGE_TYPE.ADMIN === type) {
                    query = ref.where('to_user', '==', '1');
                } else if (MESSAGE_TYPE.MEDICAL === type) {
                    query = ref.where('to_user', '==', '2');
                } else if (MESSAGE_TYPE.SENT === type) {
                    query = ref.where('from_user', '>=', '1').where('from_user', '<=', '2').orderBy('from_user'); 
                } else if (MESSAGE_TYPE.COMPLIANCE === type) {
                    query = _db.collection('compliance_reports')
                }
                query = query.orderBy('ts', 'desc');

                if (!!startAt) {
                    // Paging
                    query = query.startAfter(startAt);
                }
                query = query.limit(PAGE_SIZE);

                if (!!query) {
                    // do query
                    query.get().then(function(snapshots) {
                        var messages = [],
                            lastSnapShot;
                        if (!!!snapshots.empty) {
                            lastSnapShot = snapshots.docs[snapshots.docs.length - 1];
                            snapshots.forEach(function(doc) {
                                let model = doc.data();
                                model.documentId = doc.id;
                                messages.push(model);
                            });
                        } else {
                            // no more messages.
                        }

                        callback(messages, lastSnapShot);
                    }).catch(function(error) {
                        console.warn('Failed to load messages from server.', error);
                        callback();
                    });
                } else {
                    console.warn('Cannot request get messages, wrong type.', type);
                    callback();
                }
            }

            function showMessageDialog(message, type) {
                let dialog = CreateMessageDialog();
                dialog.show($('.right_col'), message, function(texts) {
                    if (texts) {
                        let _type = _.isNumber(type) ? type : 2;
                        
                        if (message.to_user == '2') {
                            _type  = 2; // doctor
                        } else if (message.from_user == '1' || message.from_user == '2') {
                            _type  = 3; // reminder
                        }

                        // normal messages
                        replyMessage(message.documentId, message.from_user, message.from_name, texts.title,
                            texts.message, _type, function(replyRef) {
                                let data = _messageItems[message.documentId];
                                if (data) {
                                    data.model.reply = replyRef;
                                    data.viewItem.update(data.model);
                                }
                            });
                    }

                    dialog.hide();
                });
            }

            function showComplianceMessageDialog(message) {
                let dialog = CreateComplianceMessageDialog();
                dialog.show($('.right_col'), function(texts) {
                    if (texts) {
                        replyCompliance(message.documentId, firebase.auth().currentUser.uid,
                            texts.message, texts.type, function() {
                                refreshList();
                            });
                        dialog.hide();
                    }
                });
            }

            function showComplianceResolveDialog(message) {
                let dialog = ComplianceResolveDialog(); 
                dialog.show($('.right_col'), message);
            }

            function replyMessage(replyId, toId, toName, title, message, type, callback) {
                let _callback = callback || _.noop,
                    _newData = {
                        to_user: toId,
                        to_name: toName,
                        action: 3,
                        title: title,
                        message: message,
                        type: type,
                        ts: firebase.firestore.FieldValue.serverTimestamp()
                    };

                loadCurrentUser(function(currentUser) {
                    if (currentUser.role == 1) {
                        _newData.from_user = '1';
                    } else if (currentUser.role == 2) {
                        _newData.from_user = '2';
                    } else {
                        _newData.from_user = currentUser.documentId;
                        _newData.from_name = currentUser.fullname;
                    }

                    let docRef = _db.collection('messages').doc();
                    docRef.set(_newData).then(function() {
                        _db.collection('messages').doc(replyId).update({
                            reply: docRef
                        }).then(function() {
                            _callback(docRef);
                        });
                    });
                });
            }

            function replyCompliance(messageId, toId, message, type, callback) {
                let _callback = callback || _.noop,
                    _resolverRef = _db.collection('users').doc(toId);
                    _newData = {
                        resolution_type: type,
                        resolution_note: message,
                        resolver: _resolverRef,
                        resolution_ts: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    _db.collection('compliance_reports').doc(messageId).update(_newData)
                        .then(function() {
                            _callback();
                        });
            }

            function loadCurrentUser(callback) {
                let _callback = callback || _.noop;
                if (!_currentUser) {
                    _db.collection('users').doc(firebase.auth().currentUser.uid).get().then(function(doc) {
                        if (doc) {
                            _currentUser = doc.data();
                            _currentUser.documentId = doc.id;
                        }

                        _callback(_currentUser);
                    });
                } else {
                    _callback(_currentUser);
                }
            }

            function refreshList() {
                switchMessages(_currentMessageType, null, true);
            }

            function MessageItem(model, callbacks) {
                var _model = model,
                    _callbacks = callbacks || {
                        goToUser: _.noop,
                        selectedMessage: _.noop
                    },
                    _views = {};

                function render() {
                    let container = $('<div class="noty-item">');
                    let profile = $('<div class="noty-item-avatar">');
                    let contentContainer = $('<div class="noty-item-content-container">'),
                        titleLabel = $('<div class="noty-item-title-label">'),
                        descLabel = $('<div class="noty-item-desc-label">');
                    let locateContainer = $('<div class="noty-item-locate-container">'),
                        nameLabel = $('<div class="noty-item-name-label">'),
                        timeagoLabel = $('<div class="noty-item-timeago-label">');
                    let messageButton = $('<div class="noty-item-msg-btn">'),
                        replyButton = $('<div class="noty-item-reply-btn">');
                    let closeButton = $('<div class="noty-item-close-btn">');

                    container.append(profile, contentContainer, messageButton, replyButton, timeagoLabel, closeButton);
                    contentContainer.append(titleLabel, descLabel, locateContainer);
                    locateContainer.append(nameLabel);

                    // init handlers
                    messageButton.click(function() {
                        _callbacks.selectedMessage(model);
                    });
                    closeButton.click(function() {
                        container.detach().remove();
                        // TODO: call api?
                    })
                    profile.click(function() {
                        let userId = _model.from_user;
                        if (_model.from_user == '1' || _model.from_user == '2') {
                            userId = _model.to_user;
                        }
                        _callbacks.goToUser(userId);
                    });
                    nameLabel.click(function() {
                        let userId = _model.from_user;
                        if (_model.from_user == '1' || _model.from_user == '2') {
                            userId = _model.to_user;
                        }
                        _callbacks.goToUser(userId);
                    });
                    replyButton.click(function() {
                        // TODO!
                        _model.reply.get().then(function(doc) {
                            let reply = doc.data();
                            if (reply) {
                                reply.documentId = doc.id;
                                let dialog = MessageDialog();
                                dialog.show($('.right_col'), reply);
                            } else {
                                new PNotify({
                                    type: 'error',
                                    text: 'The reply seems to deleted and cannot be displayed.'
                                });
                                // TODO: remove reply field?

                                replyButton.hide();
                                messageButton.show();
                            }
                        });
                    });

                    // store views
                    _views.container = container;
                    _views.profile = profile;
                    _views.titleLabel = titleLabel;
                    _views.descLabel = descLabel;
                    _views.nameLabel = nameLabel;
                    _views.messageButton = messageButton;
                    _views.replyButton = replyButton;
                    _views.closeButton = closeButton;
                    _views.timeagoLabel = timeagoLabel;

                    update(_model);

                    return container;
                }

                function update(model) {
                    _model = model;

                    _views.titleLabel.text(model.title || '-');
                    _views.descLabel.text(model.message || '-');
                    _views.timeagoLabel.text($.timeago(model.ts.seconds * 1000) || '-')

                    let profileUserId = model.from_user;
                    if (model.from_user == '1' || model.from_user == '2') {
                        _views.nameLabel.text(model.to_name || '');
                        profileUserId = model.to_user;
                    } else {
                        _views.nameLabel.text(model.from_name || '');
                    }

                    // Only show message button for clinic
                    if (model.to_user == 2) {
                        if (model.reply) {
                            _views.replyButton.show();
                            _views.messageButton.hide();
                        } else {
                            _views.replyButton.hide();
                            _views.messageButton.show();
                        }
                    } else {
                        _views.messageButton.hide();
                        _views.replyButton.hide();
                    }

                    // load profile image
                    let profileUrl = 'https://skec-fujairah.loc8.dev:10443/api/download/image/' + profileUserId;
                    $('<img/>')
                        .load(function() {
                            _views.profile.css('background-image', 'url(' + profileUrl + ')');
                        })
                        .attr('src', profileUrl);
                }

                function blink() {
                    let container = _views.container;
                    if (!!container) {
                        container.addClass('new');
                        _.delay(function() {
                            container.removeClass('new');
                        });
                    }
                }

                return {
                    render: render,
                    update: update,
                    blink: blink
                }
            }

            function ComplianceMessageItem(model, callbacks) {
                const LOCATION_DISPLAY = {
                    0: 'Camp',
                    1: 'Work site',
                    2: 'Transportation',
                    3: 'Others' 
                },
                LOCATION_DISPLAY_BUILDER = _.template('[<%= place %>]');

                let _model = model,
                    _callbacks = callbacks || {
                        goToUser: _.noop,
                        selectedMessage: _.noop,
                        selectedResolve: _.noop
                    },
                    _reporter,
                    _views = {};

                function render() {
                    let container = $('<div class="noty-item">');
                    let profile = $('<div class="noty-item-avatar">');
                    let contentContainer = $('<div class="noty-item-content-container">'),
                        titleContainer = $('<div class="noty-item-title-container">'),
                        locationLabel = $('<div class="noty-item-location-label">'),
                        titleLabel = $('<div class="noty-item-title-label">'),
                        descLabel = $('<div class="noty-item-desc-label">');
                    let locateContainer = $('<div class="noty-item-locate-container">'),
                        nameLabel = $('<div class="noty-item-name-label">'),
                        timeagoLabel = $('<div class="noty-item-timeago-label">'),
                        attachmentContainer = $('<div class="noty-item-attchmentContainer">');
                    let messageButton = $('<div class="noty-item-msg-btn">'),
                        resolveButton = $('<div class="noty-item-resolve-btn">');
                    let closeButton = $('<div class="noty-item-close-btn">');

                    container.append(profile, contentContainer, messageButton, resolveButton,
                        timeagoLabel, closeButton);
                    contentContainer.append(titleContainer, descLabel, locateContainer);
                    titleContainer.append(locationLabel, titleLabel);
                    locateContainer.append(nameLabel, attachmentContainer);

                    // init handlers
                    messageButton.click(function() {
                        _callbacks.selectedMessage(model);
                    });
                    resolveButton.click(function() {
                        _callbacks.selectedResolve(model);
                    });
                    closeButton.click(function() {
                        container.detach().remove();
                        // TODO: call api?
                    })
                    profile.click(function() {
                        if (!!_model) {
                            _callbacks.goToUser(_reporter.documentId);
                        } else {
                            console.warn('Cannot move to user menu, unknown user.');
                        }
                    });
                    nameLabel.click(function() {
                        if (!!_model) {
                            _callbacks.goToUser(_reporter.documentId);
                        } else {
                            console.warn('Cannot move to user menu, unknown user.');
                        }
                    })

                    // store views
                    _views.container = container;
                    _views.profile = profile;
                    _views.locationLabel = locationLabel;
                    _views.titleLabel = titleLabel;
                    _views.descLabel = descLabel;
                    _views.nameLabel = nameLabel;
                    _views.messageButton = messageButton;
                    _views.resolveButton = resolveButton;
                    _views.closeButton = closeButton;
                    _views.timeagoLabel = timeagoLabel;
                    _views.attachmentContainer = attachmentContainer;

                    update(_model);

                    return container;
                }

                function update(model) {
                    _model = model;

                    let title = 'Social Distancing';
                    if (model.category === 1) {
                        title = 'PPE';
                    } else if (model.category === 2) {
                        title = 'Disinfection';
                    } else if (model.category === 3) {
                        title = 'Sanitizer';
                    } else if (model.category === 4) {
                        title = 'House Keeping';
                    } else if (model.category === 5) {
                        title = 'Others';
                    }
                    _views.titleLabel.text(title);

                    // Display location
                    if (_.isNumber(_model.location)) {
                        _views.locationLabel.text(LOCATION_DISPLAY_BUILDER({
                            place: LOCATION_DISPLAY[model.location]
                        }));
                    }

                    // Handle resolved
                    if (_.isNumber(_model.resolution_type)) {
                        _views.resolveButton.show();
                        _views.messageButton.hide();
                    } else {
                        _views.resolveButton.hide();
                        _views.messageButton.show();
                    }

                    // TODO: move in load api.
                    if (_model.from_user && !_model.reporter) {
                        _model.reporter = _model.from_user;
                    }
                    if (_model.reporter) {
                        _model.reporter.get().then(function(doc) {
                            if (!!doc) {
                                // Store user.
                                _reporter = doc.data();
                                _reporter.documentId = doc.id;
                                updateName(_reporter.fullname);

                                // load profile image
                                let profileUrl = 'https://skec-fujairah.loc8.dev:10443/api/download/image/' + _reporter.documentId;
                                $('<img/>')
                                    .load(function() {
                                        _views.profile.css('background-image', 'url(' + profileUrl + ')');
                                    })
                                    .attr('src', profileUrl);
                            }
                        });
                    }

                    // render attachements
                    _.each(model.attachments, function(attachmentId) {
                        let viewItem = $('<div class="noty-item-attachment">');
                        viewItem.click(function() {
                            window.open(DOWNLOAD_URL_BUILDER({
                                id: attachmentId
                            }));
                        });

                        _views.attachmentContainer.append(viewItem);
                    });

                    _views.descLabel.text(model.message || '-');
                    _views.timeagoLabel.text($.timeago(model.ts.seconds * 1000) || '-');
                }

                function updateName(fullname) {
                    _views.nameLabel.text(fullname || '-');
                }

                function blink() {
                    let container = _views.container;
                    if (!!container) {
                        container.addClass('new');
                        _.delay(function() {
                            container.removeClass('new');
                        });
                    }
                }

                return {
                    render: render,
                    upate: update,
                    blink: blink
                }
            }

            function CreateMessageDialog() {
                const TITLE_DISPLAY_BUILDER = _.template('Reply: <%= name %>(<%= id %>)');

                let _views,
                    _callback = _.noop;

                function render() {
                    let container = $('<div class="c-modal-dialog cmessage-dialog">'),
                        contentContainer = $('<div class="c-modal-dialog-content cmessage-dialog-content">'),
                        closeButton = $('<div class="c-modal-dialog-close-btn cmessage-dialog-close-btn">'),
                        titleTextbox = $('<input type="text" class="dialog-textbox cmessage-dialog-title-textbox" placeholder="Reply Title">'),
                        messageTextarea = $('<textarea class="dialog-textarea cmessage-dialog-message-textarea" placeholder="Enter messages.">');
                    let sendButton = $('<div class="dialog-btn cmessage-dialog-send-btn">'),
                        sendButtonLabel = $('<div class="cmessage-dialog-send-btn-label">Send</div>'),
                        sendButtonIcon = $('<div class="cmessage-dialog-send-btn-icon">');

                    // init handlers
                    container.click(function() {
                        // hide();
                    });
                    closeButton.click(function() {
                        hide();
                    })

                    sendButton.click(function() {
                        let title = titleTextbox.val(),
                            message = messageTextarea.val();

                        if (title.trim().length > 0) {
                            _callback({
                                title: title,
                                message: message
                            });
                        } else {
                            window.alert('Please enter title.');
                        }
                    });
                    titleTextbox.change(function() {
                        if ($(this).val().trim().length <= 0) {
                            // TODO:
                        }
                    });

                    container.append(contentContainer);
                    contentContainer.append(closeButton, titleTextbox, messageTextarea, sendButton);
                    sendButton.append(sendButtonLabel, sendButtonIcon);

                    // Store views
                    _views = {};
                    _views.container = container;
                    _views.titleTextbox = titleTextbox;
                }

                function show(parent, message, callback) {
                    _callback = callback || _.noop;
                    render();
 
                    if (message) {
                        _views.titleTextbox.val(TITLE_DISPLAY_BUILDER({
                            name: message.from_name,
                            id: message.from_user
                        }));
                    }

                    parent.append(_views.container);
                }

                function hide() {
                    _views.container.remove();
                    _views = null;
                    _callback = _.noop;
                }

                return {
                    show: show,
                    hide: hide
                }
            }

            function CreateComplianceMessageDialog() {
                let _views,
                    _callback = _.noop;

                function render() {
                    let container = $('<div class="c-modal-dialog cmessage-dialog">'),
                        contentContainer = $('<div class="c-modal-dialog-content cmessage-dialog-content">'),
                        closeButton = $('<div class="c-modal-dialog-close-btn cmessage-dialog-close-btn">'),
                        typeSelector = $('<select name="resolve_type" class="dialog-selector cmessage-dialog-selector">'),
                        messageTextarea = $('<textarea class="dialog-textarea cmessage-dialog-message-textarea" placeholder="Enter messages.">');
                    let sendButton = $('<div class="dialog-btn cmessage-dialog-send-btn">'),
                        sendButtonLabel = $('<div class="cmessage-dialog-send-btn-label">Send</div>'),
                        sendButtonIcon = $('<div class="cmessage-dialog-send-btn-icon">');

                    // init handlers
                    container.click(function() {
                        // hide();
                    });
                    closeButton.click(function() {
                        hide();
                    })

                    sendButton.click(function() {
                        let message = messageTextarea.val();

                        _callback({
                            type: parseInt(typeSelector.val()),
                            message: message
                        });
                    });

                    container.append(contentContainer);
                    contentContainer.append(closeButton, typeSelector, messageTextarea, sendButton);
                    sendButton.append(sendButtonLabel, sendButtonIcon);
                    typeSelector.append('<option value="1">Open</option>')
                        .append('<option value="2">Closed</option>')
                        .append('<option value="3">Postponed</option>')
                        .append('<option value="4">Declined</option>');

                    // Store views
                    _views = {};
                    _views.container = container;
                }

                function show(parent, callback) {
                    _callback = callback || _.noop;
                    render();

                    parent.append(_views.container);
                }

                function hide() {
                    _views.container.remove();
                    _views = null;
                    _callback = _.noop;
                }

                return {
                    show: show,
                    hide: hide
                }
            }

            function MessageDialog() {
                let _views,
                    _callback = _.noop;

                function render() {
                    let container = $('<div class="c-modal-dialog cmessage-dialog">'),
                        contentContainer = $('<div class="c-modal-dialog-content cmessage-dialog-content">'),
                        closeButton = $('<div class="c-modal-dialog-close-btn cmessage-dialog-close-btn">'),
                        fromNameTitleLabel = $('<div class="dialog-title-label">From</div>'),
                        fromNameValueLabel = $('<div class="dialog-value-label">'),
                        fromTitleTitleLabel = $('<div class="dialog-title-label">Title</div>'),
                        fromTitleValueLabel = $('<div class="dialog-value-label">'),
                        messageTitleLabel = $('<div class="dialog-title-label">Message</div>'),
                        messageValueLabel = $('<div class="dialog-value-label">');

                    // init handlers
                    container.click(function() {
                        // hide();
                    });
                    closeButton.click(function() {
                        hide();
                    })

                    container.append(contentContainer);
                    contentContainer.append(closeButton, fromNameTitleLabel, fromNameValueLabel, fromTitleTitleLabel,
                        fromTitleValueLabel, messageTitleLabel, messageValueLabel);

                    // Store views
                    _views = {};
                    _views.container = container;
                    _views.fromNameValueLabel = fromNameValueLabel;
                    _views.fromTitleValueLabel = fromTitleValueLabel;
                    _views.messageValueLabel = messageValueLabel;
                }

                function show(parent, reply, callback) {
                    _callback = callback || _.noop;
                    render();

                    if (reply) {
                        let _fromName = 'Admin';
                        if (reply.from_name) {
                            _fromName = reply.from_name;
                        } else if (reply.from_user == '2') {
                            _fromName = 'Clinic';
                        }
                        _views.fromNameValueLabel.text(_fromName);
                        _views.fromTitleValueLabel.text(reply.title);
                        _views.messageValueLabel.text(reply.message);
                    }

                    parent.append(_views.container);
                }

                function hide() {
                    _views.container.remove();
                    _views = null;
                    _callback = _.noop;
                }

                return {
                    show: show,
                    hide: hide
                }
            }

            function ComplianceResolveDialog() {
                const TYPE_DISPLAY = {
                    1: 'Open',
                    2: 'Closed',
                    3: 'Postponed',
                    4: 'Others'
                };

                let _views,
                    _callback = _.noop;


                function render() {
                    let container = $('<div class="c-modal-dialog c-resolve-dialog">'),
                        contentContainer = $('<div class="c-modal-dialog-content">'),
                        closeButton = $('<div class="c-modal-dialog-close-btn cmessage-dialog-close-btn">'),
                        resolverTitleLabel = $('<div class="dialog-title-label">Resolver</div>'),
                        resolverValueLabel = $('<div class="dialog-value-label">'),
                        typeTitleLabel = $('<div class="dialog-title-label">Type</div>'),
                        typeValueLabel = $('<div class="dialog-value-label">'),
                        timeTitleLabel = $('<div class="dialog-title-label">Date</div>'),
                        timeValueLabel = $('<div class="dialog-value-label">'),
                        noteTitleLabel = $('<div class="dialog-title-label">Note</div>'),
                        noteValueLabel = $('<div class="dialog-value-label">');

                    // init handlers
                    container.click(function() {
                        // hide();
                    });
                    closeButton.click(function() {
                        hide();
                    })

                    container.append(contentContainer);
                    contentContainer.append(closeButton, resolverTitleLabel, resolverValueLabel, typeTitleLabel,
                        typeValueLabel, timeTitleLabel, timeValueLabel, noteTitleLabel, noteValueLabel);

                    // Store views
                    _views = {};
                    _views.container = container;
                    _views.resolverValueLabel = resolverValueLabel;
                    _views.typeValueLabel = typeValueLabel;
                    _views.timeValueLabel = timeValueLabel;
                    _views.noteValueLabel = noteValueLabel;
                }

                function show(parent, message) {
                    render();

                    // Updates the views.
                    if (message) {
                        if (message.resolver) {
                            message.resolver.get().then(function(doc) {
                                _views.resolverValueLabel.text(doc.data().fullname);
                            });
                        }
                        _views.typeValueLabel.text(TYPE_DISPLAY[message.resolution_type]);
                        _views.timeValueLabel.text($.timeago(message.resolution_ts.seconds * 1000));
                        _views.noteValueLabel.text(message.resolution_note);
                    }

                    parent.append(_views.container);
                }

                function hide() {
                    _views.container.remove();
                    _views = null;
                    _callback = _.noop;
                }

                return {
                    show: show,
                    hide: hide
                }
            }
        })();
    </script>
{% endblock javascripts %}
