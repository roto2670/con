{% extends "base_site.html" %}

{% block sidebar %}
    <div class="nav_sidebar_hidden col-md-3 left_col {% block sidebar_class %} {% endblock sidebar_class %}">
        {% include "site_template/sidebar_covid19.html" %}
    </div>
{% endblock sidebar %}

{% block stylesheets %}
    {{ super() }}
    <link type="text/css" rel="stylesheet" href="static/css/common.css">
    <link type="text/css" rel="stylesheet" href="static/css/news.css">
{% endblock stylesheets %}

{% block title %}{% endblock title %}

{% block content %}
<div id="scroll-style-hidden" class="right_col base" role="main">
    <div class="top-container">
        <div class="add-news-menu-container">
            <div class="add-news-btn"></div>
            <div class="add-news-menu hide">
                <div class="add-news-menu-item file">
                    <div class="ads-mi-icn">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve" width="512px" height="512px" class="">
                            <path d="M459.36,100.64l-96-96C360.341,1.645,356.253-0.024,352,0H96c-26.51,0-48,21.49-48,48v416c0,26.51,21.49,48,48,48h320     c26.51,0,48-21.49,48-48V112C464.025,107.747,462.355,103.66,459.36,100.64z M432,464c0,8.837-7.163,16-16,16H96     c-8.837,0-16-7.163-16-16V48c0-8.837,7.163-16,16-16h240v64c0,17.673,14.327,32,32,32h64V464z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                            <rect x="368" y="384" width="32" height="32" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                            <rect x="112" y="224" width="288" height="32" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                            <rect x="112" y="304" width="288" height="32" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                            <rect x="112" y="384" width="224" height="32" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                        </svg>
                    </div>
                    <div class="ads-mi-label">File</div>
                </div>
                <div class="add-news-menu-item youtube">
                    <div class="ads-mi-icn">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve" width="512px" height="512px">
                            <path d="M258.53,71.003l-0.724-0.002c-0.01,0-0.018,0-0.028,0c-5.51,0-9.985,4.459-10,9.973c0,0.008,0,0.016,0,0.024    c-0.002,5.512,4.458,9.988,9.973,10.003l0.725,0.002c0.009,0,0.018,0,0.027,0c5.51,0,9.985-4.459,10-9.973    c0-0.008,0-0.016,0-0.024C268.505,75.494,264.045,71.018,258.53,71.003z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                            <path d="M501.391,133.108c-6.566-24.965-25.935-44.626-50.542-51.31c-25.375-6.911-96.12-9.456-151-10.373    c-5.49-0.075-10.074,4.31-10.166,9.832c-0.092,5.522,4.31,10.074,9.832,10.166c75.96,1.27,127.838,4.705,146.085,9.674    c17.73,4.816,31.697,19.031,36.45,37.104c9.83,37.283,9.95,116.997,9.95,117.797c0,0.801-0.12,80.515-9.951,117.804    c-4.752,18.067-18.719,32.282-36.455,37.1c-36.648,9.98-188.069,10.097-189.594,10.097c-1.525,0-152.946-0.118-189.6-10.099    c-17.73-4.816-31.697-19.031-36.45-37.104C20.12,336.513,20,256.799,20,255.999c0-0.801,0.12-80.515,9.951-117.803    c4.752-18.067,18.719-32.282,36.455-37.1c18.647-5.078,72.059-8.537,150.399-9.742c5.522-0.084,9.929-4.63,9.845-10.152    c-0.085-5.522-4.645-9.893-10.153-9.845c-56.569,0.869-129.439,3.387-155.34,10.44c-24.613,6.685-43.982,26.347-50.546,51.306    C0.121,172.891,0,252.624,0,255.999s0.121,83.108,10.609,122.89c6.566,24.965,25.935,44.626,50.542,51.31    c39.208,10.677,188.513,10.8,194.849,10.8s155.641-0.123,194.843-10.798c24.613-6.685,43.982-26.347,50.546-51.306    C511.879,339.107,512,259.374,512,255.999S511.879,172.891,501.391,133.108z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                            <path d="M58,229.521c-5.523,0-10,4.477-10,10v81.5c0,5.523,4.477,10,10,10s10-4.477,10-10v-81.5    C68,233.998,63.523,229.521,58,229.521z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                            <path d="M58,184.021c-5.523,0-10,4.477-10,10v0.118c0,5.523,4.477,10,10,10s10-4.477,10-10v-0.118    C68,188.498,63.523,184.021,58,184.021z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                            <path d="M337.106,248.873l-124-72c-3.094-1.797-6.911-1.804-10.011-0.019c-3.1,1.785-5.011,5.09-5.011,8.667v144    c0,3.578,1.911,6.882,5.011,8.667c1.544,0.889,3.266,1.333,4.989,1.333c1.735,0,3.47-0.45,5.022-1.352l124-72    c3.083-1.79,4.979-5.084,4.979-8.648C342.085,253.957,340.188,250.663,337.106,248.873z M218.084,312.151v-109.26l94.085,54.63    L218.084,312.151z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                        </svg>
                    </div>
                    <div class="ads-mi-label">Youtube</div>
                </div>
                <div class="add-news-menu-item image">
                    <div class="ads-mi-icn">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve" width="512px" height="512px">
                            <path d="M0,61v390h512V61H0z M482,421H51.213L155,317.213l61,61l180-180l86,86V421z M482,241.787l-86-86l-180,180l-61-61l-125,125    V91h452V241.787z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                            <path d="M155,121c-33.084,0-60,26.916-60,60s26.916,60,60,60s60-26.916,60-60S188.084,121,155,121z M155,211    c-16.542,0-30-13.458-30-30s13.458-30,30-30s30,13.458,30,30S171.542,211,155,211z" data-original="#000000" class="active-path" data-old_color="#000000" fill="#E3E9ED"/>
                        </svg>
                    </div>
                    <div class="ads-mi-label">Image</div>
                </div>
            </div>
        </div>
    </div>
    <div class="content-container">
        <div class="news-items-container pin"></div>
        <div class="news-items-container unpin"></div>
    </div>

    <div class="news-item-loader-btn loading">
        <div class="news-item-loader-icon"></div>
        <div class="news-item-loader-label">Load more</div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
    {{ super() }}
      <script src="static/js/vendor/sortable/sortable.min.js"></script>
      <script src="static/js/vendor/sortable/jquery-sortable.js"></script>
    <script>
        (function() {
            const IS_INTERNAL = {{is_internal|tojson}};
            const PAGE_SIZE = 10,
                UPLOAD_COUNT_LIMIT = 3,
                UPLOAD_SIZE_LIMIT = 5; // 5mb
            const UPLOAD_URL_BUILDERS = {
                INTERNAL: _.template('//172.16.5.8:5678/<%= type %>?id=<%= id %>'),
                EXTERNAL: _.template('https://skec-fujairah.loc8.dev:10443/api/upload/<%= type %>?id=<%= id %>')
            },
            DOWNLOAD_URL_BUILDERS = {
                INTERNAL: _.template('//172.16.5.8:8888/<%= type %>/<%= id %>'),
                EXTERNAL: _.template('https://skec-fujairah.loc8.dev:10443/api/download/<%= type %>/<%= id %>')
            },
            UPLOAD_URL_BUILDER = IS_INTERNAL ? UPLOAD_URL_BUILDERS.INTERNAL : UPLOAD_URL_BUILDERS.EXTERNAL,
            DOWNLOAD_URL_BUILDER = IS_INTERNAL ? DOWNLOAD_URL_BUILDERS.INTERNAL : DOWNLOAD_URL_BUILDERS.EXTERNAL;

            const MAX_PIN_ORDER = 100,  
                PIN_ORDER_INCREMENT = 1;
                UNPIN_ORDER_INCREMENT = 1000;

            let _db = firebase.firestore(),
                _newsItems = {},
                _loadingNews = false,
                _initializedSnapshotHandler = false,
                _lastSnapshot = null;

            // init
            // remove hard-coded to change the order of news items by drag.
            $('body').removeAttr('ondragstart');

            initHandlers();
            initSortableNewsItems();
            displayNews(function() {
                $('.news-item-loader-btn').removeClass('loading');
            })
            initSnapshotHandler();

            function initHandlers() {
                $('.add-news-btn').click(function(event) {
                    event.preventDefault();
                    event.stopPropagation();

                    showAddMenu();
                });
                $(document).click(function() {
                    hideAddMenu();
                });

                $('.news-item-loader-btn').click(function() {
                    let _this = $(this);
                    displayNews();
                });

                // init add menus
                $('.add-news-menu-item.file').click(function() {
                    window.alert('Not ready yet!');
                });
                $('.add-news-menu-item.youtube').click(function() {
                    showAddYoutubeDialog();
                });
                $('.add-news-menu-item.image').click(function() {
                    showAddImageDialog();
                });
            }

            function initSortableNewsItems() {
                // init sortable items.
                $('.news-items-container.unpin').sortable({
                    animation: 150,
                    handle: '.ni-grab-btn',
                    ghostClass: 'ni-news-item-ghost',
                    onSort: function(event) {
                        let currentViewItem = $(event.item),
                            prevViewItem = currentViewItem.prev(),
                            nextViewItem = currentViewItem.next();

                        let currentOrder = currentViewItem.data('order'),
                            prevOrder = currentViewItem.prev().data('order') || 0,
                            nextOrder = currentViewItem.next().data('order');

                        if (_.isNumber(currentOrder)) {
                            let newOrder = Math.round((prevOrder + nextOrder) / 2);
                            if (!nextOrder) {
                                // there is no next order
                                newOrder = getNextUnpinOrder();
                                nextOrder = newOrder + UNPIN_ORDER_INCREMENT;
                            }

                            if (prevOrder < newOrder && nextOrder > newOrder ) {
                                updateOrder(currentViewItem.data('documentId'), newOrder);
                            }
                        }
                    }
                });
            }

            function initSnapshotHandler() {
                // listen new news item.
                _db.collection('bulletin_items')
                    .orderBy('ts', 'desc')
                    .limit(1)
                    .onSnapshot(function(snapshot) {
                        if (!_initializedSnapshotHandler) {
                            // FIXME: OnSnapshot first loads all the documents that match the query.
                            _initializedSnapshotHandler = true;
                            return;
                        }
                        snapshot.docChanges().forEach(function(change) {
                            if (change.type === 'added') {
                                let model = change.doc.data();
                                    newsObj = _newsItems[change.doc.id];

                                model.documentId = change.doc.id;
                                if (snapshot.metadata.hasPendingWrites) {
                                    // This has not yet been recorded on the server, so must manually set the time field.
                                    model.ts = {
                                        seconds: new Date().getTime() / 1000
                                    };
                                }
                                if (!_.has(_newsItems, change.doc.id)) {
                                    addNewsItem(model);
                                } else {
                                    updateNewsItem(model);
                                }
                            }
                        });
                    });
            }

            function showAddYoutubeDialog(model) {
                let dialog = AddYoutubeDialog(),
                    uploading = false,
                    filesQueue = null;

                dialog.show($('.right_col'), model, {
                    selectedAdd: function(title, body, lang, link, files) {
                        if (!uploading) {
                            uploading = true;
    
                            filesQueue = makeFileUrls(files, false);
                            // Upload attachments.
                            uploadFiles(0, filesQueue, dialog, function(files) {
                                // Write to firestore.
                                let queryData = {
                                        title: title,
                                        content: body || '',
                                        order: getNextUnpinOrder(),
                                        type: 'youtube',
                                        media_url: link,
                                        lang: lang,
                                        ts: {
                                            seconds: new Date().getTime() / 1000
                                        }
                                    };
    
                                if (!_.isEmpty(filesQueue)) {
                                    let files = [];
                                    _.each(filesQueue, function(file) {
                                        files.push(_.pick(file, 'download_url', 'filename'));
                                    });
                                    queryData.files = files;
                                }
    
                                addNews(queryData);
                                dialog.hide();    
                            });
                        } else {
                            // Already uploading.
                        }
                    },
                    selectedEdit: function(title, body, lang, link) {
                        // Update to firestore.
                        let queryData = {
                                title: title,
                                content: body || '',
                                order: model.order,
                                type: 'youtube',
                                media_url: link,
                                lang: lang,
                                ts: {
                                    seconds: new Date().getTime() / 1000
                                }
                            };

                        updateNews(model.documentId, queryData);
                        updateNewsItem(_.extend(model, queryData));
                        dialog.hide();
                    }
                });
            }

            function showAddImageDialog(model) {
                let dialog = AddImageDialog(),
                    uploading = false,
                    imageQueue = null,
                    filesQueue = null;

                dialog.show($('.right_col'), model, {
                    selectedAdd: function(title, message, lang, image, files) {
                        if (!uploading) {
                            uploading = true;

                            imageQueue = makeFileUrls([image], true);
                            filesQueue = makeFileUrls(files, false);
                            // Upload image first.
                            uploadFiles(0, imageQueue, dialog, function(imageUrls) {
                                // Upload attachments.
                                uploadFiles(0, filesQueue, dialog, function(files) {
                                    // Write to firestore.
                                    let queryData = {
                                            title: title,
                                            content: message,
                                            order: 1000,
                                            type: 'image',
                                            media_url: _.first(imageQueue).download_url,
                                            lang: lang,
                                            ts: {
                                                seconds: new Date().getTime() / 1000
                                            }
                                        };

                                    if (!_.isEmpty(filesQueue)) {
                                        let files = [];
                                        _.each(filesQueue, function(file) {
                                            files.push(_.pick(file, 'download_url', 'filename'));
                                        });
                                        queryData.files = files;
                                    }

                                    addNews(queryData);
                                    dialog.hide();    
                                });
                            });
                        } else {
                            // Already uploading.
                        }
                    },
                    selectedEdit: function(title, message, lang) {
                        // Updates to firestore.
                        let queryData = {
                                title: title,
                                content: message || '',
                                order: 1000,
                                type: 'image',
                                lang: lang,
                                ts: {
                                    seconds: new Date().getTime() / 1000
                                }
                            };

                        updateNews(model.documentId, queryData);
                        updateNewsItem(_.extend(model, queryData));
                        dialog.hide();    
                    }
                });
            }

            function makeFileUrls(files, image) {
                let queue = [];
                _.each(files, function(file) {
                    let fileId = makeUUID();
                    queue.push({
                        filename: file.name || 'unnamed',
                        upload_url: makeUploadUrl(image, fileId),
                        download_url: makeDownloadUrl(image, fileId),
                        file: file
                    })
                });

                return queue;
            }

            function uploadFiles(currentIndex, files, dialog, callback) {
                let _file = null,
                    _callback = callback || _.noop;
                if (currentIndex < _.size(files)) {
                    _file = files[currentIndex];
                    
                    dialog.setFileName(_file.filename);
                    dialog.setFileCount(currentIndex + 1, _.size(files));
                    uploadFile(_file, {
                        progress: function(progress) {
                            dialog.setProgress(progress);
                        },
                        success: function() {
                            dialog.setProgress(100);
                            uploadFiles(++currentIndex, files, dialog, _callback);
                        }
                    });
                } else {
                    _callback();
                }
            }

            function uploadFile(file, callbacks) {
                let _callbacks = callbacks || {
                    progress: _.noop,
                    success: _.noop,
                    error: _.noop
                };
                if (file) {
                    let formData = new FormData();
                    formData.append('file', file.file, file.filename); 

                    $.ajax({
                        url: file.upload_url,
                        data: formData,
                        type: 'post',
                        contentType: false,
                        processData: false,
                        xhr: function() {
                            let xhr = $.ajaxSettings.xhr();
                            xhr.upload.onprogress = function(event) {
                                _callbacks.progress(event.loaded * 100 / event.total);
                            }

                            return xhr;
                        },
                        success: function() {
                            _callbacks.success();
                        },
                    });
                } else {
                    _callbacks.error();
                }
            }

            function showAddMenu() {
                $('.add-news-menu').removeClass('hide');
            }

            function hideAddMenu() {
                $('.add-news-menu').addClass('hide');
            }

            function displayNews(callback) {
                let _callback = callback || _.noop;
                let loader = $('.news-item-loader-btn');

                loader.addClass('loading').removeClass('hide');
                if (!!!_loadingNews) {
                    _loadingNews = true;

                    loadNews(_lastSnapshot, function(newsList, lastSnapshot) {
                        if (!!lastSnapshot) {
                            _lastSnapshot = lastSnapshot;
                        } else {
                            // no more items.
                            loader.addClass('hide');
                        }

                        // Add news item
                        _.each(newsList, function(news) {
                            addNewsItem(news);
                        });

                        if (_.size(newsList) < PAGE_SIZE) {
                            // no more items.
                            loader.addClass('hide');
                        }

                        _loadingNews = false;
                        loader.removeClass('loading');
                        _callback();
                    });
                } else {
                    console.warn('Already fetching news from server.');
                    loader.removeClass('loading');
                    _callback();
                }
            }

            function addNewsItem(news, prepend) {
                // TODO: by order?
                if (!!news) {
                    let container = $('.news-items-container.unpin'),
                        viewItem,
                        newsItem = NewsItem(news, {
                            selectedRemove: function(documentId) {
                                if (window.confirm('Are you sure?')) {
                                    viewItem.detach().remove();

                                    // do query.
                                    if (documentId) {
                                        _db.collection('bulletin_items').doc(documentId).delete();
                                    }
                                }
                            },
                            selectedEdit: function(selectedModel) {
                                if (selectedModel.type === 'youtube') {
                                    showAddYoutubeDialog(selectedModel);
                                } else if (selectedModel.type === 'image') {
                                    showAddImageDialog(selectedModel);
                                }
                            },
                            selectedPin: function(pinned) {
                                let _pinned = !pinned;
                                    _order = getNextPinOrder();
                                
                                if (!_pinned) {
                                    _order = getNextUnpinOrder();
                                }

                                updateNews(news.documentId, {
                                    order: _order
                                });
                                rearrangeNewsItem(news.documentId, _order);
                            }
                        });
                    
                    if (isPinNews(news)) {
                        container = $('.news-items-container.pin');
                    }
                    
                    viewItem = newsItem.render();
                    if (prepend) {
                        container.prepend(viewItem);
                    } else {
                        container.append(viewItem);
                    }

                    // store in cache
                    _newsItems[news.documentId] = {
                        model: news,
                        view: newsItem
                    }
                } else {
                    console.warn('Failed to draw new item by given model cannot be null.');
                }
            }

            function updateOrder(documentId, newOrder) {
                let _newsObj = _newsItems[documentId];
                if (_newsObj && _.isNumber(newOrder)) {
                    _newsObj.model.order = newOrder; 
                    _newsObj.view.setOrder(newOrder);

                    // Updates the db
                    updateNews(documentId, {
                        order: newOrder
                    });
                }
            }

            function updateNewsItem(news) {
                let viewObj = _newsItems[news.documentId];
                if (viewObj) {
                    viewObj.view.update(news);
                    viewObj.model = news;
                } else {
                    console.warn('Failed to update news view item, cannot find view item by given model.', news);
                }
            }

            function rearrangeNewsItem(documentId, newOrder){
                let viewObj = _newsItems[documentId];

                if (viewObj) {
                    _view = viewObj.view,
                    _container = $('.news-items-container.pin');

                    let oldPinned = isPinNews(viewObj.model),
                        newPinned = isPinNews(null, newOrder);
                    _view.setOrder(newOrder);

                    if (oldPinned != newPinned) {
                        let viewItem = _view.getView();
                        viewItem.detach();

                        if (!newPinned) {
                            _container = $('.news-items-container.unpin');
                        } else {
                            _container.append(viewItem);
                        }
                    }

                    // update model
                    viewObj.model.order = newOrder;
                }
            }

            function addNews(data) {
                if (_.isObject(data) && !_.isEmpty(data)) {
                    let _data = {
                        title: data.title,
                        content: data.content || '',
                        order: data.order,
                        type: data.type,
                        media_url: data.media_url,
                        lang: data.lang,
                        ts: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    if (data.files) {
                        _data.files = data.files;
                    }
                    _db.collection('bulletin_items').doc().set(_data);
                } else {
                    console.warn('Failed to add new to server, given data is wrong.', data);
                }
            }

            function updateNews(documentId, data) {
                if (documentId && _.isObject(data) && !_.isEmpty(data)) {
                    let _data = _.extend(data, {
                        ts: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    _db.collection('bulletin_items').doc(documentId).update(_data);
                } else {
                    console.warn('Failed to add new to server, given data is wrong.', data);
                }
            }

            function loadNews(startAt, callback) {
                let _callback = callback || _.noop;

                let ref = _db.collection('bulletin_items'),
                    query;

                query = ref.limit(PAGE_SIZE)
                            .orderBy('order');

                if (!!startAt) {
                    query = query.startAfter(startAt);
                }
                
                query.get().then(function(snapshot) {
                    let newsList = [],
                        lastSnapshot;
                    if (!!!snapshot.empty) {
                        lastSnapshot = snapshot.docs[snapshot.docs.length - 1];
                        snapshot.forEach(function(doc) {
                            let news = doc.data();
                            news.documentId = doc.id;
                            newsList.push(news);
                        });
                    } else {
                        // no more news?
                    }

                    callback(newsList, lastSnapshot);
                });
            }

            function isPinNews(news, order) {
                return MAX_PIN_ORDER >= (order || news.order);
            }

            function getNextPinOrder() {
                let max = 0,
                    current = 0;
                _.each(_newsItems, function(newsObj) {
                    current = newsObj.model.order + PIN_ORDER_INCREMENT;
                    if (max < current && current <= MAX_PIN_ORDER)  {
                        max = current;
                    }
                });

                return max || 1;
            }

            function getNextUnpinOrder() {
                let max = 0,
                    current = 0;
                _.each(_newsItems, function(newsObj) {
                    current = newsObj.model.order;
                    if (max < current)  {
                        max = current;
                    }
                });

                return max + UNPIN_ORDER_INCREMENT;
            }

            function makeUploadUrl(image, fileId) {
                return UPLOAD_URL_BUILDER({
                    type: image ? 'image' : 'file',
                    id: fileId || makeUUID()
                });
            }

            function makeDownloadUrl(image, fileId) {
                return DOWNLOAD_URL_BUILDER({
                    type: image ? 'image' : 'file',
                    id: fileId || makeUUID()
                });
            }

            function makeUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                  });
            }

            function NewsItem(model, callbacks) {
                let _views = {},
                    _callbacks = callbacks || {
                        selectedRemove: _.noop,
                        selectedEdit: _.noop
                    },
                    _pinned = false,
                    _model = model;

                function render() {
                    let container = $('<div class="news-item">'),
                        upperContainer = $('<div class="ni-upper-container">'),
                        lowerContainer = $('<div class="ni-lower-container">');
                    let grabButton = $('<div class="ni-grab-btn">'),
                        thumbnail = $('<div class="ni-thumbnail">');
                    let contentContainer = $('<div class="ni-content-container">'),
                        titleLabel = $('<div class="ni-title-label">'),
                        messageLabel = $('<div class="ni-message-label">');
                    let timeagoLabel = $('<div class="ni-timeago-label">');
                    let rightContainer = $('<div class="ni-right-container">'),
                        removeButton = $('<div class="ni-remove-btn">'),
                        pinButton = $('<div class="ni-pin-btn">');

                    container.append(upperContainer, lowerContainer);
                    upperContainer.append(grabButton, thumbnail, contentContainer, timeagoLabel, rightContainer);
                    contentContainer.append(titleLabel, messageLabel);
                    rightContainer.append(removeButton, pinButton);

                    // Init handlers
                    thumbnail.click(function() {
                        window.open(model.media_url);
                    });
                    removeButton.click(function() {
                        _callbacks.selectedRemove(model.documentId);
                    });
                    titleLabel.click(function() {
                        _callbacks.selectedEdit(_model);
                    });
                    pinButton.click(function() {
                        _callbacks.selectedPin(_pinned);
                    });

                    _views.container = container;
                    _views.lowerContainer = lowerContainer;
                    _views.grabButton = grabButton;
                    _views.thumbnail = thumbnail;
                    _views.titleLabel = titleLabel;
                    _views.messageLabel = messageLabel;
                    _views.timeagoLabel = timeagoLabel;
                    _views.removeButton = removeButton;
                    _views.pinButton = pinButton;

                    update(_model);

                    return container;
                }

                function update(model) {
                    _model = model

                    // set id and order using by jquery
                    _views.container.data('documentId', model.documentId);

                    if (model.type === "image") {
                        _views.thumbnail.css('background-image', 'url("' + model.media_url + '")')
                    } else if (model.type === 'youtube') {
                        let parsed = null;
                        try { parsed = getVideoId(model.media_url);
                        } catch(error) {
                            // nothing.
                        }

                        if (_.size(parsed) > 1) {
                            let thumbUrl = 'https://img.youtube.com/vi/' + parsed[1] + '/0.jpg';
                            _views.thumbnail.css('background-image', 'url("' + thumbUrl + '")')
                        } else {
                            // display default thumbnail.
                        }
                    }

                    _views.titleLabel.text(model.title || '-');
                    _views.messageLabel.text(model.content || '');
                    _views.timeagoLabel.text($.timeago(model.ts.seconds * 1000) || '-');

                    // draw attachments if has
                    _views.lowerContainer.empty();
                    _.each(model.files, function(file) {
                        let item = $('<div class="ni-attach-item">'),
                            icon = $('<div class="ni-attach-icn">');
                            nameLabel = $('<div class="ni-attach-name-label">');
                        
                        item.append(icon, nameLabel);
                        nameLabel.text(file.filename);
                        _views.lowerContainer.append(item);

                        item.click(function() {
                            // TODO: fix
                            window.open(file.download_url);
                        });
                    });

                    setOrder(model.order);
                }

                function setOrder(order) {
                    _pinned = order <= MAX_PIN_ORDER;
                    _views.container.data('order', order);
                    _views.container.attr('order', order);

                    // check pinned
                    if (_pinned) {
                        _views.pinButton.addClass('pin');
                    } else {
                        _views.pinButton.removeClass('pin');
                    }
                }

                function getView() {
                    return _views.container;
                }

                function getVideoId(url) {
                    return url.match(/(?:https?:\/{2})?(?:w{3}\.)?youtu(?:be)?\.(?:com|be)(?:\/watch\?v=|\/)([^\s&]+)/);
                }

                return {
                    render: render,
                    update: update,
                    setOrder: setOrder,
                    getView: getView
                }
            }

            function AddYoutubeDialog() {
                let _views = {},
                    _model;

                function show(parent, model, callbacks) {
                    let _callbacks = callbacks || {
                        selectedAdd: _.noop,
                        selectedEdit: _.noop
                    };
                    _model = model;

                    let container = $('<div class="add-news-dialog youtube c-modal-dialog">'),
                        contentContainer = $('<div class="and-content-container c-modal-dialog-content">'),
                        closeButton = $('<div class="and-close-btn c-modal-dialog-close-btn">');
                    let titleLabel = $('<div class="and-title-label">YouTube</div>'),
                        descLabel = $('<div class="and-desc-label">It\'s a Youtube type of news. Please enter the YouTube URL.</div>'),
                        inputTitleTextbox = $('<input type="text" class="and-input-title-textbox dialog-textbox" placeholder="News title">'),
                        messageTextarea = $('<textarea class="and-message-textarea dialog-message-textarea" placeholder="Will be displayed with the YouTube link.">'),
                        linkTextbox = $('<input type="text" class="and-textbox dialog-textbox" placeholder="Please enter YouTube link.">');
                    let langSelector = $('<select name="lang" class="and-lang-selector">');
                    let imageUploaderContainer = $('<div class="and-image-container">'),
                        imageTitleLabel = $('<div class="and-subtitle-label">Image</div>'),
                        selectImageButton = $('<input type="file" class="and-upload-btn" accept="image/*">');
                    let filesTitleLabel = $('<div class="and-subtitle-label">Attachments</div>'),
                        filesUploaderContainer = $('<div class="and-files-container">'),
                        uploadDescLabel = $('<div class="and-desc-label">Up to 5 files and up to 5 mb per file.</div>'),
                        selectFilesButton = $('<input type="file" class="and-upload-btn" multiple>');
                    let bottomContainer = $('<div class="and-bottom-container">'),
                        fileNameContainer = $('<div class="and-filename-container">'),
                        fileNameLabel = $('<div class="and-desc-label filename">'),
                        countLabel = $('<div class="and-desc-label filecount">'),
                        progress = $('<div class="and-progress">'),
                        addButton = $('<div class="and-add-btn dialog-btn">ADD</div>');

                    container.append(contentContainer);
                    contentContainer.append(closeButton, titleLabel, descLabel, inputTitleTextbox, messageTextarea,
                        linkTextbox, langSelector, imageUploaderContainer, filesUploaderContainer, bottomContainer);
                    imageUploaderContainer.append(imageTitleLabel, selectImageButton).hide();
                    filesUploaderContainer.append(filesTitleLabel, uploadDescLabel, selectFilesButton);

                    bottomContainer.append(fileNameContainer, progress, addButton);
                    fileNameContainer.append(fileNameLabel, countLabel);

                    langSelector.append($('<option value="en" selected="selected">English</option>'))
                        .append($('<option value="ko">한국어</option>'))
                        .append($('<option value="zh">中文</option>'))
                        .append($('<option value="ar">العربية</option>'))
                        .append($('<option value="hi">हिन्दी</option>'))
                        .append($('<option value="ur">اردو</option>'));

                    // init handlers
                    closeButton.click(function() {
                        hide();
                    });
                    $(document).keyup(function(e) {
                        if (e.key === "Escape") {
                            hide();
                       }
                    });
                    addButton.click(function() {
                        let title = inputTitleTextbox.val().trim(),
                            message = messageTextarea.val().trim(),
                            link = linkTextbox.val().trim(),
                            images = selectImageButton.prop('files'),
                            files = selectFilesButton.prop('files'),
                            image = null; 

                        if (_.isEmpty(title)) {
                            window.alert('Please enter title.');
                            return;
                        }

                        if (_.isEmpty(link)) {
                            // TODO: valid url.
                            window.alert('Please enter YouTube link.');
                            return;
                        }

                        // check attachment
                        if (!_.isEmpty(files)) {
                            if (UPLOAD_SIZE_LIMIT < files.length) {
                                window.alert('You can only upload a maximum of ' + UPLOAD_SIZE_LIMIT + 'files.');
                                event.preventDefault();
                                return;
                            }

                            if (_.find(files, function(file) {
                                return  UPLOAD_SIZE_LIMIT < (file.size / 1024 / 1024).toFixed(4);
                            })) {
                                window.alert('You can\'t upload files that are over 5mb.');
                                event.preventDefault();
                                return;
                            }
                        }

                        if (model) {
                            _callbacks.selectedEdit(title, message, langSelector.val(), link);
                        } else {
                            _callbacks.selectedAdd(title, message, langSelector.val(), link, files);
                        }
                    });

                    // store views.
                    _views.container = container;
                    _views.fileNameLabel = fileNameLabel;
                    _views.countLabel = countLabel;
                    _views.progress = progress;
                    _views.addButton = addButton;
                    _views.titleTextbox = inputTitleTextbox;
                    _views.messageTextarea = messageTextarea;
                    _views.langSelector = langSelector;
                    _views.linkTextbox = linkTextbox;
                    _views.imageUploadButton = selectImageButton;
                    _views.imageUploader = imageUploaderContainer;
                    _views.filesUploadButton = selectFilesButton;
                    _views.filesUploader = filesUploaderContainer;

                    update(model);

                    parent.append(container);
                }

                function hide() {
                    _views.container.detach().remove();
                }

                function update(model) {
                    _model = model;
                    if (_.isObject(model)) {
                        _views.titleTextbox.val(model.title);
                        _views.messageTextarea.val(model.content);
                        _views.langSelector.val(model.lang);
                        _views.linkTextbox.val(model.media_url);

                        // hide uploaders
                        _views.imageUploader.hide();
                        _views.filesUploader.hide();

                        _views.addButton.text('UPDATE');
                    }
                }

                function setProgress(progress) {
                    if (_.isNumber(progress)) {
                        _views.progress.css('width', progress + '%');
                    }
                }

                function setFileName(name) {
                    _views.fileNameLabel.text(name);
                }

                function setFileCount(current, max) {
                    _views.countLabel.text('(' + current + '/' + max + ')');
                }

                return {
                    show: show,
                    hide: hide,
                    setProgress: setProgress,
                    setFileName: setFileName,
                    setFileCount: setFileCount
                }
            }

            function AddImageDialog() {
                let _views = {},
                    _mode;;

                function show(parent, model, callbacks) {
                    let _callbacks = callbacks || {
                        selectedAdd: _.noop,
                        selectedEdit: _.noop
                    };
                    _model = model;

                    let container = $('<div class="add-news-dialog image c-modal-dialog">'),
                        contentContainer = $('<div class="and-content-container c-modal-dialog-content">'),
                        closeButton = $('<div class="and-close-btn c-modal-dialog-close-btn">');
                    let titleLabel = $('<div class="and-title-label">Image</div>'),
                        descLabel = $('<div class="and-desc-label">Message will be displayed with image.</div>'),
                        inputTitleTextbox = $('<input type="text" class="and-input-title-textbox dialog-textbox" placeholder="News title">'),
                        messageTextarea = $('<textarea class="and-message-textarea dialog-message-textarea" placeholder="Will be displayed with the YouTube link.">');
                    let langSelector = $('<select name="lang" class="and-lang-selector">');
                    let imageUploaderContainer = $('<div class="and-image-container">'),
                        imageTitleLabel = $('<div class="and-subtitle-label">Image</div>'),
                        selectImageButton = $('<input type="file" class="and-upload-btn" accept="image/*">');
                    let filesTitleLabel = $('<div class="and-subtitle-label">Attachments</div>'),
                        filesUploaderContainer = $('<div class="and-files-container">'),
                        uploadDescLabel = $('<div class="and-desc-label">Up to 5 files and up to 5 mb per file.</div>'),
                        selectFilesButton = $('<input type="file" class="and-upload-btn" multiple>');
                    let bottomContainer = $('<div class="and-bottom-container">'),
                        fileNameContainer = $('<div class="and-filename-container">'),
                        fileNameLabel = $('<div class="and-desc-label filename">'),
                        countLabel = $('<div class="and-desc-label filecount">'),
                        progress = $('<div class="and-progress">'),
                        addButton = $('<div class="and-add-btn dialog-btn">ADD</div>');

                    container.append(contentContainer);
                    contentContainer.append(closeButton, titleLabel, descLabel, inputTitleTextbox, messageTextarea,
                        langSelector, imageUploaderContainer, filesUploaderContainer, bottomContainer);
                    imageUploaderContainer.append(imageTitleLabel, selectImageButton);
                    filesUploaderContainer.append(filesTitleLabel, uploadDescLabel, selectFilesButton);

                    bottomContainer.append(fileNameContainer, progress, addButton);
                    fileNameContainer.append(fileNameLabel, countLabel);

                    langSelector.append($('<option value="en" selected="selected">English</option>'))
                        .append($('<option value="ko">한국어</option>'))
                        .append($('<option value="zh">中文</option>'))
                        .append($('<option value="ar">العربية</option>'))
                        .append($('<option value="hi">हिन्दी</option>'))
                        .append($('<option value="ur">اردو</option>'));

                    // init handlers
                    closeButton.click(function() {
                        hide();
                    });
                    $(document).keyup(function(e) {
                        if (e.key === "Escape") {
                            hide();
                       }
                    });
                    addButton.click(function(event) {
                        let title = inputTitleTextbox.val().trim(),
                            message = messageTextarea.val().trim(),
                            images = selectImageButton.prop('files'),
                            files = selectFilesButton.prop('files'),
                            image = null; 
                        if (_.isEmpty(title)) {
                            window.alert('Please enter title.');
                            event.preventDefault();
                            return;
                        }

                        // check image
                        if (!model) {
                            if (_.isEmpty(images)) {
                                window.alert('Please select image to upload.');
                                event.preventDefault();
                                return;
                            } else {
                                image = images[0];
                                if (UPLOAD_SIZE_LIMIT < (image.size / 1024 / 1024).toFixed(4)) {
                                    window.alert('You can\'t upload image that over 5mb.');
                                    event.preventDefault();
                                    return;
                                }
                            }
                        }

                        // check attachment
                        if (!_.isEmpty(files)) {
                            if (UPLOAD_SIZE_LIMIT < files.length) {
                                window.alert('You can only upload a maximum of ' + UPLOAD_SIZE_LIMIT + 'files.');
                                event.preventDefault();
                                return;
                            }

                            if (_.find(files, function(file) {
                                return  UPLOAD_SIZE_LIMIT < (file.size / 1024 / 1024).toFixed(4);
                            })) {
                                window.alert('You can\'t upload files that are over 5mb.');
                                event.preventDefault();
                                return;
                            }
                        }

                        if (model) {
                            _callbacks.selectedEdit(title, message, langSelector.val(), image, files);
                        } else {
                            _callbacks.selectedAdd(title, message, langSelector.val(), image, files);
                        }
                    });

                    // store views.
                    _views.container = container;
                    _views.fileNameLabel = fileNameLabel;
                    _views.countLabel = countLabel;
                    _views.progress = progress;
                    _views.addButton = addButton;
                    _views.titleTextbox = inputTitleTextbox;
                    _views.messageTextarea = messageTextarea;
                    _views.langSelector = langSelector;
                    _views.imageUploadButton = selectImageButton;
                    _views.imageUploader = imageUploaderContainer;
                    _views.filesUploadButton = selectFilesButton;
                    _views.filesUploader = filesUploaderContainer;

                    update(model);
                
                    parent.append(container);
                }

                function hide() {
                    _views.container.detach().remove();
                }

                function update(model) {
                    _model = model;
                    if (_.isObject(model)) {
                        _views.titleTextbox.val(model.title);
                        _views.messageTextarea.val(model.content);
                        _views.langSelector.val(model.lang);

                        // hide uploaders
                        _views.imageUploader.hide();
                        _views.filesUploader.hide();

                        _views.addButton.text('UPDATE');
                    }
                }

                function setProgress(progress) {
                    if (_.isNumber(progress)) {
                        _views.progress.css('width', progress + '%');
                    }
                }

                function setFileName(name) {
                    _views.fileNameLabel.text(name);
                }

                function setFileCount(current, max) {
                    _views.countLabel.text('(' + current + '/' + max + ')');
                }

                return {
                    show: show,
                    hide: hide,
                    setProgress: setProgress,
                    setFileName: setFileName,
                    setFileCount: setFileCount
                }
            }
        })();
    </script>
{% endblock javascripts %}
