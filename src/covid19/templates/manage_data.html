{% extends "base_site.html" %}

{% block sidebar %}
    <div class="nav_sidebar_hidden col-md-3 left_col {% block sidebar_class %} {% endblock sidebar_class %}">
        {% include "site_template/sidebar_covid19.html" %}
    </div>
{% endblock sidebar %}

{% block stylesheets %}
    {{ super() }}
    <link type="text/css" rel="stylesheet" href="static/css/common.css">
    <link type="text/css" rel="stylesheet" href="static/css/managedata.css">
{% endblock stylesheets %}

{% block title %}{% endblock title %}

{% block content %}
<div id="scroll-style-hidden" class="right_col base" role="main">
    {% if current_user.level != 9 %}
    <div class="title-container">
        <div class="title-icon stats"></div>
        <div class="title-label">Data Management</div>
    </div>
    <div class="content-container stats">
        <div class="sub-title-label">Stats</div>
        <div class="items-container stats">
            <div class="items-desc-label">
                Manually update the stats to display on the dashboard
            </div>
            <div class="stat-items-container"></div>
            <div class="si-bottom-container">
                <div class="si-update-label"></div>
                <div class="si-update-btn btn">Update</div>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="title-container">
        <div class="title-icon tests"></div>
        <div class="title-label">Master File</div>
    </div>
    <div class="content-container upload">
        <div class="upload-content-container">
            <!-- step 1: download master file -->
            <div class="upload-container">
                <div class="uc-title-label">1. Download the latest Master file</div>
                <div class="uc-content-container">
                    <div class="upload-icon excel"></div>
                    <div class="download-button btn">Download</div>
                    <div class="uc-mf-date-label">N/A</div>
                </div>
            </div>
            <div class="upload-r-arrow-icon"></div>
            <!-- step 2: updates the master file -->
            <div class="upload-container small">
                <div class="uc-title-label">2. Update the Mster file</div>
                <div class="uc-content-container">
                    <div class="upload-icon update-mf"></div>
                    <div class="uc-bottom-label">Apply your changes</div>
                </div>
            </div>
            <div class="upload-r-arrow-icon"></div>
            <!-- step 3: updates the master file -->
            <div class='upload-container uploader'>
                <div class='uc-title-label'>3. Upload the new Master file</div>
                <div class="upload-icon uploader"></div>
                <div class="uc-bottom-label">Drag & Drop a file</div>
                <div class="or-label">or</div>
                <input type="file" class="browse-button btn" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
            </div>
        </div>

        <div class="log-panel users hide">
            <div class="log-panel-title">
                <i class="fa fa-angle-right users-log" aria-hidden="true"></i>
                <span class="log-panel-title-label">Logs</span>
            </div>
            <div class="log-panel-value"></div>
        </div>
    </div>

    <!-- Download files -->
    <div class="title-container">
        <div class="title-icon downloads"></div>
        <div class="title-label">Downloads</div>
    </div>
    <div class="content-container donwloads">
        <div class="si-content-container logs">
            <div class="log-download-container">
                <div class="download-sub-container master">
                    <div class="download-title-label">Master</div>
                    <div class="log-download-btn" id="master">Master file</div>
                </div>
                <div class="download-sub-container logs">
                    <div class="download-title-label">Logs</div>
                    <div class="log-download-btn-container">
                        <div class="log-download-btn" id="app_usage">Daily app usage report</div>
                        <div class="log-download-run-btn btn" id="app_usage">Run</div>
                    </div>
                    <div class="log-download-btn-container">
                        <div class="log-download-btn" id="observation">Observation report</div>
                        <div class="log-download-run-btn btn" id="observation">Run</div>
                    </div>
                    <div class="log-download-btn-container">
                        <div class="log-download-btn" id="clinic_reports">Clinic Report</div>
                        <div class="log-download-run-btn btn" id="clinic_reports">Run</div>
                    </div>
                </div>
                <div class="download-sub-container qr">
                    <div class="download-title-label">QR Codes</div>
                    <div class="log-download-btn-container">
                        <div class="log-download-btn" id="qr_codes">All QR Codes</div>
                        <div class="log-download-run-btn btn" id="qr_codes">Generate</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
    {{ super() }}
    <script src="static/js/vendor/moment/moment.min.js"></script>
    <script src="static/js/vendor/moment/moment-timezone-with-data.min.js"></script>
    <script>
        (function() {
            const IS_INTERNAL = {{is_internal|tojson}};
            const IS_DEV = false;
            const UPLOAD_URL_BUILDERS = {
                INTERNAL: _.template('//172.16.5.8:10443/api/upload/<%= type %>?id=<%= id %>'),
                EXTERNAL: _.template('//skec-fujairah.loc8.dev:10443/api/upload/<%= type %>?id=<%= id %>'),
                DEV: _.template('//skfksxpzm.mib.io:10443/api/upload/<%= type %>?id=<%= id %>')
            },
            DOWNLOAD_URL_BUILDERS = {
                INTERNAL: _.template('//172.16.5.8:10443/api/download/<%= type %>/<%= id %>'),
                EXTERNAL: _.template('//skec-fujairah.loc8.dev:10443/api/download/<%= type %>/<%= id %>'),
                DEV: _.template('//skfksxpzm.mib.io:10443/api/download/<%= type %>/<%= id %>')
            },
            TIME_URL_BUILDERS = {
                INTERNAL: _.template('//172.16.5.8:10443/api/upload/time?id=<%= id %>'),
                EXTERNAL: _.template('//skec-fujairah.loc8.dev:10443/api/upload/time?id=<%= id %>'),
                DEV: _.template('//skfksxpzm.mib.io:10443/api/upload/time?id=<%= id %>')
            },
            SCRIPT_URL_BUILDERS = {
                INTERNAL: _.template('//172.16.5.8:10443/api/upload/run?id=<%= id %>'),
                EXTERNAL: _.template('//skec-fujairah.loc8.dev:10443/api/upload/run?id=<%= id %>'),
                DEV: _.template('//skfksxpzm.mib.io:10443/api/upload/run?id=<%= id %>')
            },
            UPLOAD_AVAILABLE_URL_BUILDERS = {
                INTERNAL: _.template('//172.16.5.8:10443/api/upload/available/csv'),
                EXTERNAL: _.template('//skec-fujairah.loc8.dev:10443/api/upload/available/csv'),
                DEV: _.template('//skfksxpzm.mib.io:10443/api/upload/available/csv')
            };
            UPLOAD_URL_BUILDER = IS_DEV ? UPLOAD_URL_BUILDERS.DEV : IS_INTERNAL ? UPLOAD_URL_BUILDERS.INTERNAL : UPLOAD_URL_BUILDERS.EXTERNAL,
            DOWNLOAD_URL_BUILDER = IS_DEV ? DOWNLOAD_URL_BUILDERS.DEV : IS_INTERNAL ? DOWNLOAD_URL_BUILDERS.INTERNAL : DOWNLOAD_URL_BUILDERS.EXTERNAL,
            TIME_URL_BUILDER = IS_DEV ? TIME_URL_BUILDERS.DEV : IS_INTERNAL ? TIME_URL_BUILDERS.INTERNAL : TIME_URL_BUILDERS.EXTERNAL,
            SCRIPT_URL_BUILDER = IS_DEV ? SCRIPT_URL_BUILDERS.DEV : IS_INTERNAL ? SCRIPT_URL_BUILDERS.INTERNAL : SCRIPT_URL_BUILDERS.EXTERNAL,
            UPLOAD_AVAILABLE_URL_BUILDER = IS_DEV ? UPLOAD_AVAILABLE_URL_BUILDERS.DEV : IS_INTERNAL ? UPLOAD_AVAILABLE_URL_BUILDERS.INTERNAL : UPLOAD_AVAILABLE_URL_BUILDERS.EXTERNAL;

            const MANUAL_STATS_KEY_LIST = ["confirmed", "deaths", "recovered", "active_positives",
                "quarantined", "isolated", "hospitalized", "close_contacts", "symptomatics", "country_total_cases",
                "country_total_deaths", "stringency_index", "headcount", "alert_phase"],
                MANUAL_STATS_DISPLAY = {
                    'confirmed': 'Confirmed',
                    'deaths': 'Deaths',
                    'recovered': 'Recovered',
                    'active_positives': "Active/Positive",
                    'quarantined': 'Quarantined',
                    'isolated': 'Isolated',
                    'close_contacts': 'Close Contacts',
                    'symptomatics': 'Suspected symptom',
                    'hospitalized': 'Hospitalized',
                    'selfassessments': 'Self-Assessments',
                    'country_total_cases': 'UAE Total cases',
                    'country_total_deaths': 'UAE Total deaths',
                    'stringency_index': 'Stringency Index',
                    'headcount': 'Headcount',
                    'alert_phase': 'Alert Phase'
                },
                TIMEZONE = 'Asia/Dubai';
            const USERS_UPLOAD_ERROR_MESSAGE = {
                '-1': 'Failed to apply master file. It\'s an unknown error.',
                0: 'Failed to apply master file. The master file seems to invalid. See logs.',
                1: 'An error occurred while applying the master file. See logs.',
                2: 'Server Error. Please refer to the logs.',
                102: 'The uploaded master file has a low revision. Please download the latest version of the master file again and retry.',
                103: 'Invalid master file. Please check if it is the correct master file.',
                104: 'Mutax error. Another master file is applying. Please try again later.'
            };
            const DONWLOAD_FILENAME = {
                    master: 'master_file.xlsx',
                    app_usage: 'daily_app_usage_report.csv',
                    observation: 'observation_report.csv',
                    qr_codes: 'qrcodes.zip',
                    clinic_reports: 'clinic_reports.csv'
                },
                DOWNLOAD_FILE_DISPLAY = {
                    master: 'Master file',
                    app_usage: 'Daily app usage report',
                    observation: 'Observation report',
                    qr_codes: 'All QR codes',
                    clinic_reports: 'Clinic Reports'
                },
                UPLOAD_RESULT_STATUS = {
                    success: 0,
                    fail: 1,
                    server_error: 2,
                    conflict: 100,
                    processing: 101,
                    revision: 102,
                    invalid_master_file: 103,
                    mutex_error: 104
                },
                SCRIPT_ID = {
                    app_usage: 2,
                    observation: 3,
                    qr_codes: 8,
                    clinic_reports: 9

                },
                RUN_SCRIPT_MESSAGE = {
                    SUCCESS: {
                        app_usage: 'Genearted an app usage report.',
                        observation: 'Generated an observation report.',
                        qr_codes: 'Generating QR codes, Please reload after a few minutes.',
                        clinic_reports: 'Generated a clinic report.'
                    },
                    ERROR: {
                        app_usage: 'Failed to generation an app usage report. Check the logs in Settings menu.',
                        observation: 'Failed to generation an observation report. Check the logs in Settings menu.',
                        qr_codes: 'Failed to start QR codes generation. Please try again later.',
                        clinic_reports: 'Failed to generation a clinic report. Check the logs in Settings menu.',
                    },
                    BUSY: {
                        qr_codes: 'Already generating QR codes. Please check later.'
                    }
                },
                OBSERVATION_VALID_DAY = 7;

            let _db = firebase.firestore(),
                _stats,
                _statsDate;
            let _downloadFilesTime = {};
            let _statViewItems = {};

            // init
            initialize();
            initHandlers();
            // load stats
            loadStats(function(stats) {
                _stats = stats;
                _statsDate = new Date(stats.ts.seconds * 1000);

                buildStatsItems(stats);
            });
            // Load users logs.
            _.defer(function() {
                loadUsersLog();
                loadFileTime();
                loadDownloadFiles();
            });


            function buildStatsItems(stats) {
                if (stats) {
                    let _container = $('.stat-items-container');
                    _.each(MANUAL_STATS_KEY_LIST, function(key) {
                        let _viewItem = StatItem(MANUAL_STATS_DISPLAY[key], stats[key]);
                        _container.append(_viewItem.render());    
                    
                        _statViewItems[key] = _viewItem;
                    });
                }
            }

            function loadStats(callback) {
                let _callback = callback || _.noop;

                _db.collection('covid19_stats')
                    .orderBy('ts', 'desc')
                    .limit(1).get().then((snapshot) => {
                        var today = {};
                        if (!snapshot.empty) {
                            let doc = _.last(snapshot.docs);
                            today = doc.data();
                            today.documentId = doc.id;
                        }

                        _callback(today); 
                    });
            }

            function addStats(newStats, callbacks) {
                let _callbacks = callbacks || {
                    success: _.noop,
                    error: _.noop
                };
                if (newStats)  {
                    let _data = _.extend(newStats, {
                        ts: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    let ref = _db.collection('covid19_stats').doc();
                    ref.set(_data).then(function() {
                        // Updates stats date for update next time.
                        _statsDate = new Date();
                        _stats.documentId = ref.id;

                        _callbacks.success();
                    }).catch(function() {
                        _callbacks.error();
                    });
                } else {
                    console.warn('Failed to add new stats by given data is null.');
                    _callbacks.error();
                }
            }

            function updateStats(documentId, newStats, callbacks) {
                let _callbacks = callbacks || {
                    success: _.noop,
                    error: _.noop
                };

                if (documentId && newStats) {
                    let _data = _.extend(newStats, {
                        ts: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    _db.collection('covid19_stats').doc(documentId).update(_data).then(function() {
                        _callbacks.success();
                    }).catch(function() {
                        _callbacks.error();
                    });
                } else {
                    _callbacks.error();
                }
            }

            function initialize() {
                // init Noty
                PNotify.prototype.options.delay = 5000;
                PNotify.prototype.options.styling = 'bootstrap3';
            }

            function initHandlers() {
                $('.si-update-btn').click(function() {
                    let _newStats = {},
                        _hasInvalidValue = false;
                
                    _.each(_statViewItems, function(statsItem, key) {
                        if (statsItem.isChanged()) {
                            let _value = statsItem.getValue();
                            if (_.isNumber(_value) && !_.isNaN(_value)) {
                                _newStats[key] = _value;
                            } else {
                                _hasInvalidValue = true;
                            }
                        }
                    });

                    if (_hasInvalidValue) {
                        new PNotify({
                            type: 'notice',
                            text: 'You can only input numbers.'
                        });

                        return;
                    }

                    if (!_.isEmpty(_newStats)) {
                        let _statsDate,
                            _todayDate = new Date();
                        if (!_.isEmpty(_stats.ts)) {
                            _statsDate = new Date(_stats.ts.seconds * 1000);
                        }

                        if (isFutureDay(_statsDate, _todayDate)) {
                            // Adds new stats.
                            _newStats = _.extend(_stats, _newStats);

                            addStats(_newStats, {
                                success: function() {
                                    updateStats(_newStats);
                                    // update view item
                                    updateStatsItem(_newStats);
                                    new PNotify({
                                        type: 'success',
                                        text: 'Manual stats updated successfully.'
                                    });
                                }, error: function() {
                                    new PNotify({
                                        type: 'error',
                                        text: 'Failed to manual update stats.'
                                    });
                                }
                            });
                        } else {
                            // Updates current stats.
                            updateStats(_stats.documentId, _newStats, {
                                success: function() {
                                    updateStats(_newStats);
                                    // update view item
                                    updateStatsItem(_newStats);
                                    new PNotify({
                                        type: 'success',
                                        text: 'Manual stats updated successfully.'
                                    });
                                }, error: function() {
                                    new PNotify({
                                        type: 'error',
                                        text: 'Failed to manual update stats.'
                                    });
                                }
                            });
                        }
                    } else {
                        new PNotify({
                            type: 'notice',
                            text: 'There is no changes.'
                        });
                    }
                });

                // for upload
                $('.browse-button').change(function() {
                    let file = _.first($(this).prop('files'));
                    prepareUpload(file);
                });
                $('.upload-container.uploader>.upload-icon').click(function() {
                    $('.browse-button').click();
                });
                $('.upload-container.uploader').on('dragenter', function(event) {
                    event.preventDefault();
                    $(this).addClass('hover');
                });
                $('.upload-container.uploader').on('dragleave', function(event) {
                    event.preventDefault();
                    $(this).removeClass('hover');
                });
                $('.upload-container.uploader').on('dragover', function(event) {
                    event.preventDefault();
                });
                $('.upload-container.uploader').on('drop', function(event) {
                    event.preventDefault();
                    $(this).removeClass('hover');

                    let file = _.first(event.originalEvent.dataTransfer.files);
                    if (_.first((/[.]/.exec(file.name)) ? /[^.]+$/.exec(file.name) : null) != 'xlsx' &&
                        (file.type != 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                        file.type != 'application/vnd.ms-excel')) {
                            new PNotify({
                                type: 'notice',
                                text: 'Please upload the excel file.'
                            });
                    } else {
                        $('.browse-button').prop('files', event.originalEvent.dataTransfer.files);
                        prepareUpload(file);
                    }
                });

                // download master file
                $('.download-button').click(function() {
                    downloadURI(DOWNLOAD_URL_BUILDER({
                        type: 'csv',
                        id: DONWLOAD_FILENAME.master
                    }));
                });

                // log panel
                $('.log-panel-title').click(function() {
                    let valuePanel = $('.log-panel-value'),
                        arrow = $('.fa.users-log');
                    if (valuePanel.hasClass('max')) {
                        valuePanel.removeClass('max');
                    } else {
                        valuePanel.addClass('max');
                    }

                    if (arrow) {
                        if (arrow.hasClass('fa-angle-right')) {
                            arrow.removeClass('fa-angle-right');
                            arrow.addClass('fa-angle-down');
                        } else {
                            arrow.addClass('fa-angle-right');
                            arrow.removeClass('fa-angle-down');
                        }
                    }
                });

                // handle download logs button
                $('.log-download-btn').click(function() {
                    let type = $(this).attr('id'),
                        fileType = 'csv';
                    if (type == 'qr_codes') {
                        fileType = 'res';
                    }

                    downloadURI(DOWNLOAD_URL_BUILDER({
                        type: fileType,
                        id: DONWLOAD_FILENAME[type]
                    }));
                });

                // handle run script button
                $('.log-download-run-btn#observation').click(function() {
                    // check validate date
                    if (_downloadFilesTime.observation) {
                        let sourceDate = moment(_downloadFilesTime.observation),
                            todayDate = moment(),
                            diffDay = todayDate.diff(sourceDate, 'day');

                        if (diffDay > OBSERVATION_VALID_DAY) {
                            // make observation report.
                            if (window.confirm('Are you sure?')) {
                                runScript('observation');
                            }
                        } else {
                            new PNotify({
                                type: 'notice',
                                text: 'Must be ' + OBSERVATION_VALID_DAY + 'days after the last run. ' + 
                                    'Please try again in ' + ((OBSERVATION_VALID_DAY - diffDay) + 1) + 'day(s).'
                            });
                        }
                    } else {
                        new PNotify({
                            type: 'error',
                            text: 'Please try again when the last execution date displayed.'
                        });
                    }
                });

                // add lisnter for daily app usage reports.
                $('.log-download-run-btn#app_usage').click(function() {
                    if (window.confirm('Aure you sure?')) {
                        runScript('app_usage');
                        new PNotify({
                            type: 'info',
                            text: 'Please wait...'
                        });
                    }
                }); 

                // add lisnter for generate qr codes
                $('.log-download-run-btn#qr_codes').click(function() {
                    if (window.confirm('This is a heavy task and may not be response for a few minutes. Are you sure?')) {
                        runScript('qr_codes');
                        $('.log-download-btn#qr_codes').text(DOWNLOAD_FILE_DISPLAY['qr_codes'] + '(Generating...)');
                    }
                }); 

                // add lisnter for clinic reports.
                $('.log-download-run-btn#clinic_reports').click(function() {
                    if (window.confirm('Aure you sure?')) {
                        runScript('clinic_reports');
                    }
                }); 
            }

            function prepareUpload(file) {
                if (!window.confirm('Are you sure you want to upload the master file?')) {
                    return;
                }
                let localTime = moment().tz(TIMEZONE);
                if (localTime.hour() == 0) {
                    new PNotify({
                        type: 'notice',
                        text: 'Master file cannot be applied from 0:00 AM to 1:00 AM. Please try again later. '
                    });
                    return;
                }

                // check extenstion.
                if (file) {
                    // clear file
                    $('.browse-button').val('');

                    // check file extention
                    if (_.first((/[.]/.exec(file.name)) ? /[^.]+$/.exec(file.name) : null) == 'xlsx' ||
                        file.type == 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || 
                        file.type == 'application/vnd.ms-excel') {
                            upload(file);
                    } else {
                        new PNotify({
                            type: 'notice',
                            text: 'Please upload the exel file.'
                        });
                    }
                } else {
                    new PNotify({
                        type: 'notice',
                        text: 'Please select a file to upload(.xlsx)'
                    });
                }
            }

            function upload(file) {
                // show progress dialog first.
                let dialog = UploadDialog(),
                    progressWidget = UploadProgressDialogWidget();
                dialog.show($('.right_col'));
                dialog.setWidget(progressWidget.render());

                // upload file
                uploadFile(file, UPLOAD_URL_BUILDER({
                    type: 'csv',
                    id: DONWLOAD_FILENAME.master
                }), {
                    progress: function(progress) {
                        progressWidget && progressWidget.setProgress(progress);

                        if (progress >= 100) {
                            // show script log viewer.
                            let logWidget = UploadLogWidget();
                            dialog.setWidget(logWidget.render());
                        }
                    },
                    success: function(result) {
                        let resultWidget = UploadResultWidget(); 
                        dialog.setWidget(resultWidget.render('success'));
                        dialog.setCloseButtonVisible(true);

                        loadUsersLog();
                        loadFileTime();
                    },
                    error: function(reason) {
                        let resultWidget = UploadResultWidget(); 
                        dialog.setCloseButtonVisible(true);
                        if (reason == UPLOAD_RESULT_STATUS.conflict) {
                            dialog.setWidget(resultWidget.render('conflict'));
                        } else if (reason == UPLOAD_RESULT_STATUS.processing) {
                            dialog.setWidget(resultWidget.render('processing'));
                        } else if (reason == UPLOAD_RESULT_STATUS.revision) {
                            dialog.setWidget(resultWidget.render('conflict'));
                        } else {
                            let reasonMessage = USERS_UPLOAD_ERROR_MESSAGE[reason] || 'Unknow error. Please try again later.';
                            new PNotify({
                                type: 'error',
                                text: reasonMessage
                            });
                            
                            dialog.hide();
                        }
                        loadUsersLog();
                    }
                });
            }

            function loadUsersLog() {
                // Load users logs.
                let requestUrl = DOWNLOAD_URL_BUILDER({
                    type: 'res',
                    id: 'users.log'

                }),
                titleLabel = $('.log-panel.users').find('.log-panel-title-label');
                titleLabel.text('Logs(Fetching creation date...)');

                $.getJSON(TIME_URL_BUILDER({
                    id: 'users.log'
                }), function(data) {
                    if (data && data.time) {
                        let timeDisplay = new Date(data.time * 1000).toLocaleString();
                        $.get(requestUrl, function(text) {
                            titleLabel.text('Logs(' + timeDisplay + ')');
                            $('.log-panel.users').removeClass('hide');
                            $('.log-panel.users').children('.log-panel-value').text(text);
                        }).fail(function() {
                            titleLabel.text('Logs(N/A)');
                        });
                    } else {
                        $('.log-panel.' + type).text('Logs(N/A)');
                    }
                });
            }

            function runScript(type) {
                let _button = $('.log-download-run-btn#' + type),
                    _requestUrl = SCRIPT_URL_BUILDER({
                        id: SCRIPT_ID[type]
                    });
                
                // check running. TODO: flag
                if (_button.hasClass('disabled')) {
                    return;
                }

                $.getJSON(_requestUrl, function(data) {
                    let _data = data || {};
                    if (_data.code == 0) {
                        loadDownloadFile(type);
                        new PNotify({
                            type: 'success',
                            text: RUN_SCRIPT_MESSAGE.SUCCESS[type]
                        });
                    } else if (_data.code == 3) {
                        new PNotify({
                            type: 'notice',
                            text: RUN_SCRIPT_MESSAGE.BUSY[type]
                        });
                    } else {
                        new PNotify({
                            type: 'error',
                            text: RUN_SCRIPT_MESSAGE.ERROR[type]
                        });
                    }
                }).fail(function() {
                    new PNotify({
                        type: 'error',
                        text: 'Failed to request.'
                    });
                });
            }

            function loadFileTime() {
                // make download link for users.csv if has
                let requestUrl = TIME_URL_BUILDER({
                    id: DONWLOAD_FILENAME.master
                });
                $.getJSON(requestUrl, function(data) {
                    if (data && data.time) {
                        $('.uc-mf-date-label').text(new Date(data.time * 1000).toLocaleString());
                    }
                });
            }

            function loadDownloadFile(type) {
                return loadDownloadFiles(type);
            }

            function loadDownloadFiles(type) {
                function _loadFileTime(type) {
                    if (type) {
                        let button = $('.log-download-btn#' + type),
                            requestUrl = TIME_URL_BUILDER({
                                id: DONWLOAD_FILENAME[type]
                            });
                        
                        button.text(DOWNLOAD_FILE_DISPLAY[type] + '(Fetching creation date...)');
                        $.getJSON(requestUrl, function(data) {
                            if (data && data.time) {
                                let time = new Date(data.time * 1000),
                                    timeDisplay = time.toLocaleString();
                                button.text(DOWNLOAD_FILE_DISPLAY[type] + '(' + timeDisplay + ')');

                                // Store.
                                _downloadFilesTime[type] = time;
                            } else if (data.code == 3) {
                                button.text(DOWNLOAD_FILE_DISPLAY[type] + '(Generating...)');
                            } else {
                                button.text(DOWNLOAD_FILE_DISPLAY[type] + '(N/A)');
                            }
                        }).fail(function() {
                            button.text(DOWNLOAD_FILE_DISPLAY[type] + '(N/A)');
                        });
                    }
                }

                // load donwload times
                if (type) {
                    _loadFileTime(type);
                } else {
                    _loadFileTime('master');
                    _loadFileTime('app_usage');
                    _loadFileTime('observation');
                    _loadFileTime('clinic_reports');
                    _loadFileTime('qr_codes');
                }
            }

            function uploadFile(file, url, callbacks) {
                let _callbacks = callbacks || {
                    progress: _.noop,
                    success: _.noop,
                    error: _.noop
                };
                if (file) {
                    let formData = new FormData();
                    formData.append('file', file, file.name); 

                    $.ajax({
                        url: url,
                        data: formData,
                        type: 'post',
                        contentType: false,
                        processData: false,
                        xhr: function() {
                            let xhr = $.ajaxSettings.xhr();
                            xhr.upload.onprogress = function(event) {
                                _callbacks.progress(event.loaded * 100 / event.total);
                            }

                            return xhr;
                        },
                        success: function(result) {
                            let resultCode = -1;
                            try {
                                let parsed = $.parseJSON(result);
                                resultCode = _.isNumber(parsed.code) ? parsed.code : -1;
                            } catch(error) {
                                console.warn('Failed to parse upload result', error);
                            }
                            
                            if (resultCode == UPLOAD_RESULT_STATUS.success) {
                                _callbacks.success(resultCode);
                            } else {
                                _callbacks.error(resultCode);
                            }
                        },
                    });
                } else {
                    _callbacks.error();
                }
            }
            
            function downloadURI(uri, name) {
                var link = document.createElement("a");
                // If you don't know the name or want to use
                // the webserver default set name = ''
                link.setAttribute('download', name);
                link.href = uri;
                document.body.appendChild(link);
                link.click();
                link.remove();
            }


            function isFutureDay(source, target) {
                let result = false;
                if (source && target)  {
                    let convertedSource = moment(source).tz(TIMEZONE),
                        convertedTarget = moment(target).tz(TIMEZONE);
                    let sourceFullYear = convertedSource.year(),
                        sourceMonth = convertedSource.month(),
                        sourceDate = convertedSource.day(),
                        targetFullYear = convertedTarget.year(),
                        targetMonth = convertedTarget.month(),
                        targetDate = convertedTarget.day();

                    return sourceFullYear < targetFullYear || sourceMonth < targetMonth ||
                        sourceDate < targetDate;
                } else {
                    console.warn('Cannot check date by given source or target is null.');
                }

                return result;
            }

            function updateStatsItem(newStats) {
                _.each(newStats, function(value, key) {
                    let _viewItem = _statViewItems[key];
                    if (_viewItem) {
                        _viewItem.update(value);
                    }
                });
            }

            function StatItem(title, value) {
                let _views = {},
                    _title = title,
                    _value = value;

                function render() {
                    let container = $('<div class="stat-item">'),
                        titleLabel = $('<div class="si-title-label">'),
                        valueTextbox = $('<input type="text" class="si-value-textbox">');

                    container.append(titleLabel, valueTextbox);
                    titleLabel.text(_title);

                    // Store views
                    _views.container = container;
                    _views.valueTextbox = valueTextbox;
                    _views.valueTextbox = valueTextbox;

                    update(_value);

                    return container;
                }

                function update(value) {
                    _value = value;
                    _views.valueTextbox.val(value);
                }

                function getValue() {
                    return parseInt(_views.valueTextbox.val());
                }

                function isChanged() {
                    return _views.valueTextbox.val() != _value;
                }

                return {
                    render: render,
                    update: update,
                    getValue: getValue,
                    isChanged: isChanged
                }
            }

            function UploadDialog() {
                let _view = null;

                function show(parent) {
                    let container = $('<div class="upload-dialog c-modal-dialog">'),
                        closeButton = $('<div class="upload-dialog-close-btn c-modal-dialog-close-btn">').hide(),
                        contentContainer = $('<div class="ud-content-container c-modal-dialog-content">'),
                        widgetContainer = $('<div class="ud-widget-container">');
                    container.append(contentContainer);
                    contentContainer.append(closeButton, widgetContainer);
                    
                    parent.append(container);
                    closeButton.click(function() {
                        hide();
                    });

                    _view = {
                        container: container,
                        widgetContainer: widgetContainer,
                        closeButton: closeButton
                    }
                }

                function hide() {
                    _view.container.detach().remove();
                }

                function setWidget(widget) {
                    _view.widgetContainer.empty().append(widget);
                }

                function setCloseButtonVisible(visible) {
                    if (visible) {
                        _view.closeButton.show();
                    } else {
                        _view.closeButton.hide();
                    }
                }

                return {
                    show: show,
                    hide: hide,
                    setWidget: setWidget,
                    setCloseButtonVisible: setCloseButtonVisible
                }
            }

            function UploadProgressDialogWidget() {
                let _view = null;

                function render() {
                    let container = $('<div class="ud-progress-widget">'),
                        titleLabel = $('<div class="ud-title-label">Please wait while the Master File is being processed.</div>'),
                        progressBarContainer = $('<div class="ud-progress-container">'),
                        progressBar = $('<div class="ud-progress-bar">'),
                        descLabel = $('<div class="ud-desc-label">When the upload is complete, update it to the server. Please don\'t close the window and wait.</div>');

                    container.append(titleLabel, progressBarContainer, descLabel);
                    progressBarContainer.append(progressBar);

                    _view = {
                        container: container,
                        progressBar: progressBar
                    }

                    return container;
                }

                function setProgress(progress) {
                    if (_.isNumber(progress)) {
                        if (progress >= 100) {
                            progress = 100;
                        }

                        _view.progressBar.css('width', progress + '%');
                    }
                }

                return {
                    render: render,
                    setProgress: setProgress
                }
            }

            function UploadLogWidget() {
                const LOG_INTERVAL_TIME = 1000 * 10;
                let _view = null;

                function render() {
                    let container = $('<div class="ud-log-container">'),
                        titleLabel = $('<div class="ud-title-label">Appying the Master file. Please wait...</div>'),
                        logPanel = $('<div class="ud-log-panel">Fetching...</div>');

                    container.append(titleLabel, logPanel);

                    _view = {
                        container: container,
                        logPanel: logPanel
                    };

                    watchUploadStatus();

                    return container;
                }

                function isShowing() {
                    return _view && _view.container.parents('html').length > 0;
                }

                function watchUploadStatus() {
                    let requestUrl = DOWNLOAD_URL_BUILDER({
                        type: 'res',
                        id: 'users.log'
                    });
                    
                    // Load logs
                    _.delay(function() {
                        $.get(requestUrl, function(text) {
                            if (!_.isEmpty(text)) {
                                _view.logPanel.text(text);
                                _view.logPanel.scrollTop(_view.logPanel[0].scrollHeight);
                            }
                        }).fail(function() {
                            titleLabel.text('Logs(N/A)');
                            // TODO:
                        }).always(function() {
                            if (isShowing()) {
                                watchUploadStatus();
                            } else {
                                console.warn('Failed to display log, seems to viwer is not attached');
                            }
                        });
                    }, LOG_INTERVAL_TIME);
                }

                return {
                    render: render
                }
            }

            function UploadResultWidget() {
                const DOWNLOAD_AVAILABLE_CHECK_TIME = 1000 * 3;
                let _view = null;

                function render(type) {
                    let container = $('<div class="ud-result-widget">'),
                        titleContainer = $('<div class="ud-result-w-title-container">'),
                        titleIcon = $('<div class="ud-title-icon">'),
                        titleLabel = $('<div class="ud-title-label rw">'),
                        descLabel = $('<div class="ud-title-label rwd">'),
                        fileIcon = $('<div class="ud-file-icon">'),
                        downloadButton = $('<div class="ud-download-button btn">Download</div>'),
                        dateLabel = $('<div class="ud-desc-label date">Please wait...</div>');
                    container.append(titleContainer, descLabel, fileIcon, downloadButton, dateLabel);
                    titleContainer.append(titleIcon, titleLabel);

                    let titleText = 'Master File Sucessful!',
                        descText = 'Don\â€™t forget to download the latest Master File before you make any changes.';
                    if (type == 'conflict') {
                        titleText = 'Failed to apply your Master File!';
                        descText = 'Your Master File is too old. Please download the latest Master File and make the changes.';
                        titleIcon.addClass('error');
                    } else if (type == 'processing') {
                        titleText = 'Another Master File is being processed!';
                        descText = 'Please wait until the current process is finished. Make sure to download the latest when it becomes available.';
                        titleIcon.addClass('error');
                        downloadButton.addClass('disabled');

                        checkDownloadAvailable();
                    }
                    titleLabel.text(titleText);
                    descLabel.text(descText);

                    if (type != 'processing') {
                        let requestUrl = TIME_URL_BUILDER({
                            id: DONWLOAD_FILENAME.master
                        });
                        $.getJSON(requestUrl, function(data) {
                            if (data && data.time) {
                                _view.dateLabel.text(new Date(data.time * 1000).toLocaleString());
                            }
                        });
                    }

                    downloadButton.click(function() {
                        if (!$(this).hasClass('disabled')) {
                            downloadURI(DOWNLOAD_URL_BUILDER({
                                type: 'csv',
                                id: DONWLOAD_FILENAME.master
                            }));
                        }
                    });

                    _view = {
                        container: container,
                        downloadButton: downloadButton,
                        dateLabel: dateLabel
                    }

                    return container;
                }

                function checkDownloadAvailable() {
                    _.delay(function() {
                        let requestUrl = UPLOAD_AVAILABLE_URL_BUILDER();
                        $.getJSON(requestUrl, function(data) {
                            if (data && data.available) {
                                _view.dateLabel.text(new Date(data.lastUploadedTime * 1000).toLocaleString());
                                _view.downloadButton.removeClass('disabled');
                            }
                        });
                    }, DOWNLOAD_AVAILABLE_CHECK_TIME);
                }

                return {
                    render: render
                }
            }
        })();
    </script>
{% endblock javascripts %}
